[
  {
    "objectID": "dengue-cluster/cluster_multivariate.html",
    "href": "dengue-cluster/cluster_multivariate.html",
    "title": "Multivariate clustering",
    "section": "",
    "text": "This notebook aims to cluster the Brazilian municipalities considering climate indicators with multivariate clustering techniques."
  },
  {
    "objectID": "dengue-cluster/cluster_multivariate.html#packages",
    "href": "dengue-cluster/cluster_multivariate.html#packages",
    "title": "Multivariate clustering",
    "section": "Packages",
    "text": "Packages\n\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(dtwclust)\nlibrary(kableExtra)\nlibrary(tictoc)\nlibrary(sf)\nlibrary(DT)\nsource(\"../functions.R\")"
  },
  {
    "objectID": "dengue-cluster/cluster_multivariate.html#load-data",
    "href": "dengue-cluster/cluster_multivariate.html#load-data",
    "title": "Multivariate clustering",
    "section": "Load data",
    "text": "Load data\nDaily, scaled cases, maximum temperature, minimum temperature and precipitation.\n\ntdengue &lt;- open_dataset(sources = data_dir(\"bundled_data/tdengue.parquet\")) %&gt;%\n  select(mun, date, cases, tmax, tmin, prec) %&gt;%\n  collect()\n\ndim(tdengue)\n\n[1] 340179      6\n\n\nData for maps.\n\nuf_sf &lt;- geobr::read_state(showProgress = FALSE)\n\nUsing year 2010\n\ncoords &lt;- geobr::read_municipality(showProgress = FALSE) %&gt;%\n  st_make_valid() %&gt;%\n  st_centroid()\n\nUsing year 2010\n\n\nWarning: st_centroid assumes attributes are constant over geometries"
  },
  {
    "objectID": "dengue-cluster/cluster_multivariate.html#prepare-data",
    "href": "dengue-cluster/cluster_multivariate.html#prepare-data",
    "title": "Multivariate clustering",
    "section": "Prepare data",
    "text": "Prepare data\nFor clustering, the data must be a list of data frames with climate data and without date.\n\ngdengue &lt;- tdengue %&gt;%\n  group_by(mun) %&gt;%\n  arrange(date) %&gt;%\n  select(-date)\n\nmdengue &lt;- group_split(gdengue, .keep = FALSE) %&gt;%\n  tslist(simplify = TRUE)\n\nnames(mdengue) &lt;- group_keys(gdengue)$mun\n\n\nglimpse(mdengue[1:3])\n\nList of 3\n $ 110002: num [1:501, 1:4] -0.5104 0.668 0.668 0.0788 0.668 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:4] \"cases\" \"tmax\" \"tmin\" \"prec\"\n $ 110004: num [1:501, 1:4] -0.3964 -0.1824 0.0316 -0.3964 0.0316 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:4] \"cases\" \"tmax\" \"tmin\" \"prec\"\n $ 110011: num [1:501, 1:4] -0.392 -0.392 -0.392 -0.392 -0.392 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:4] \"cases\" \"tmax\" \"tmin\" \"prec\""
  },
  {
    "objectID": "dengue-cluster/cluster_multivariate.html#dtw-clustering",
    "href": "dengue-cluster/cluster_multivariate.html#dtw-clustering",
    "title": "Multivariate clustering",
    "section": "DTW clustering",
    "text": "DTW clustering\nTry from 2 to 20 partitions.\n\ntic()\nstdw_clust &lt;- tsclust(\n  series = mdengue, \n  type = \"partitional\", k = 2:20, \n  distance = \"dtw_basic\", \n  seed = 13\n)\ntoc()\n\n66.389 sec elapsed\n\n\n\nCluster Validity Indices (CVI)\n\nnames(stdw_clust) &lt;- paste0(\"k_\", 2:20)\nres_cvi &lt;- sapply(stdw_clust, cvi, type = \"internal\") %&gt;% \n  t() %&gt;%\n  as_tibble(rownames = \"k\") %&gt;%\n  arrange(-Sil)\n\ndatatable(res_cvi)\n\n\n\n\n\n\n\nm_sel_clust &lt;- stdw_clust[[res_cvi[[1,1]]]]\n\nplot(m_sel_clust)\n\n\n\n\n\n\nPartitions size\n\ntable(m_sel_clust@cluster)\n\n\n  1   2   3 \n178 483  18 \n\n\n\n\nPartition results\n\ncoords &lt;- coords %&gt;%\n  mutate(code_muni = substr(code_muni, 0, 6))\n\n\nm_cluster_ids &lt;- tibble(\n  code_muni = names(mdengue),\n  group = as.character(m_sel_clust@cluster)\n) %&gt;% \n  left_join(coords, by = \"code_muni\") %&gt;%\n  arrange(group, name_muni) %&gt;%\n  st_as_sf()\n\n\nsaveRDS(object = m_cluster_ids, file = \"m_cluster_ids.rds\")\n\n\nm_cluster_ids %&gt;%\n  select(group, name_muni, abbrev_state) %&gt;%\n  arrange(group, name_muni) %&gt;%\n  st_drop_geometry() %&gt;%\n  datatable()\n\n\n\n\n\n\n\nggplot() +\n  geom_sf(data = uf_sf, fill = \"lightgray\", color = \"grey20\", size=.15, show.legend = FALSE) +\n  geom_sf(data = m_cluster_ids, aes(color = group), size = 2) +\n  theme_minimal()"
  },
  {
    "objectID": "dengue-cluster/cluster_multivariate.html#session-info",
    "href": "dengue-cluster/cluster_multivariate.html#session-info",
    "title": "Multivariate clustering",
    "section": "Session info",
    "text": "Session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nRandom number generation:\n RNG:     L'Ecuyer-CMRG \n Normal:  Inversion \n Sample:  Rejection \n \nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] DT_0.30          sf_1.0-14        tictoc_1.2       kableExtra_1.3.4\n [5] dtwclust_5.5.12  dtw_1.23-1       proxy_0.4-27     timetk_2.9.0    \n [9] arrow_14.0.0     lubridate_1.9.3  forcats_1.0.0    stringr_1.5.1   \n[13] dplyr_1.1.4      purrr_1.0.2      readr_2.1.4      tidyr_1.3.0     \n[17] tibble_3.2.1     ggplot2_3.4.4    tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n  [1] rstudioapi_0.15.0   jsonlite_1.8.7      wk_0.9.0           \n  [4] magrittr_2.0.3      modeltools_0.2-23   farver_2.1.1       \n  [7] rmarkdown_2.25      vctrs_0.6.4         webshot_0.5.5      \n [10] htmltools_0.5.7     dials_1.2.0         curl_5.1.0         \n [13] s2_1.1.4            sass_0.4.7          parallelly_1.36.0  \n [16] KernSmooth_2.23-22  bslib_0.6.0         htmlwidgets_1.6.3  \n [19] plyr_1.8.9          cachem_1.0.8        zoo_1.8-12         \n [22] mime_0.12           lifecycle_1.0.4     iterators_1.0.14   \n [25] pkgconfig_2.0.3     Matrix_1.6-2        R6_2.5.1           \n [28] fastmap_1.1.1       future_1.33.0       shiny_1.8.0        \n [31] tune_1.1.2          clue_0.3-65         digest_0.6.33      \n [34] colorspace_2.1-0    furrr_0.3.1         RSpectra_0.16-1    \n [37] crosstalk_1.2.0     labeling_0.4.3      fansi_1.0.5        \n [40] yardstick_1.2.0     timechange_0.2.0    httr_1.4.7         \n [43] compiler_4.3.2      bit64_4.0.5         withr_2.5.2        \n [46] DBI_1.1.3           MASS_7.3-60         lava_1.7.3         \n [49] classInt_0.4-10     tools_4.3.2         units_0.8-4        \n [52] httpuv_1.6.12       flexclust_1.4-1     future.apply_1.11.0\n [55] nnet_7.3-19         glue_1.6.2          promises_1.2.1     \n [58] grid_4.3.2          cluster_2.1.4       reshape2_1.4.4     \n [61] generics_0.1.3      recipes_1.0.8       gtable_0.3.4       \n [64] tzdb_0.4.0          class_7.3-22        data.table_1.14.8  \n [67] hms_1.1.3           rsample_1.2.0       xml2_1.3.5         \n [70] utf8_1.2.4          ggrepel_0.9.4       geobr_1.8.1        \n [73] foreach_1.5.2       pillar_1.9.0        later_1.3.1        \n [76] splines_4.3.2       lhs_1.1.6           lattice_0.22-5     \n [79] survival_3.5-7      bit_4.0.5           tidyselect_1.2.0   \n [82] knitr_1.45          svglite_2.1.2       stats4_4.3.2       \n [85] xfun_0.41           hardhat_1.3.0       timeDate_4022.108  \n [88] stringi_1.8.1       DiceDesign_1.9      yaml_2.3.7         \n [91] workflows_1.1.3     evaluate_0.23       codetools_0.2-19   \n [94] cli_3.6.1           RcppParallel_5.1.7  rpart_4.1.21       \n [97] xtable_1.8-4        systemfonts_1.0.5   jquerylib_0.1.4    \n[100] munsell_0.5.0       Rcpp_1.0.11         globals_0.16.2     \n[103] parallel_4.3.2      ellipsis_0.3.2      gower_1.0.1        \n[106] assertthat_0.2.1    parsnip_1.1.1       GPfit_1.0-8        \n[109] listenv_0.9.0       viridisLite_0.4.2   ipred_0.9-14       \n[112] scales_1.2.1        xts_0.13.1          prodlim_2023.08.28 \n[115] e1071_1.7-13        rlang_1.1.2         rvest_1.0.3        \n[118] shinyjs_2.1.0"
  },
  {
    "objectID": "dengue-cluster/cluster_mun_year.html",
    "href": "dengue-cluster/cluster_mun_year.html",
    "title": "Yearly time series",
    "section": "",
    "text": "This notebook aims to cluster the Brazilian municipalities considering yearly dengue cases time-series similarities."
  },
  {
    "objectID": "dengue-cluster/cluster_mun_year.html#packages",
    "href": "dengue-cluster/cluster_mun_year.html#packages",
    "title": "Yearly time series",
    "section": "Packages",
    "text": "Packages\n\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(dtwclust)\nlibrary(kableExtra)\nlibrary(tictoc)\nsource(\"../functions.R\")"
  },
  {
    "objectID": "dengue-cluster/cluster_mun_year.html#load-data",
    "href": "dengue-cluster/cluster_mun_year.html#load-data",
    "title": "Yearly time series",
    "section": "Load data",
    "text": "Load data\nLoad the bundled data.\n\ndengue &lt;- open_dataset(sources = data_dir(\"bundled_data/tdengue.parquet\")) %&gt;%\n    select(mun, date, cases = cases_raw) %&gt;%\n    collect()\n\ndim(dengue)\n\n[1] 340179      3\n\n\n\nPrepare data\nThe chunk bellow executes various steps to prepare the data for clustering.\n\ntdengue &lt;- dengue %&gt;%\n  # Remove dates\n  filter(date &gt;= as.Date(\"2011-01-01\") & date &lt; as.Date(\"2020-01-01\")) %&gt;%\n  # Create year variable\n  mutate(year = year(date)) %&gt;%\n  # Create week number\n  mutate(week = epiweek(date)) %&gt;%\n  # Summarise per year and isoweek\n  group_by(mun, year, week) %&gt;%\n  summarise(cases = sum(cases, na.rm = TRUE)) %&gt;%\n  # Scale cases\n  mutate(cases = scale(cases)) %&gt;%\n  ungroup() %&gt;%\n  # Isolate municipality and year\n  mutate(mun = paste0(mun, \"_\", year)) %&gt;%\n  select(-year, week) %&gt;%\n  # Arrange data\n  arrange(mun, week) %&gt;%\n  # Prepare time series of municipalities by year\n  mutate(mun = paste0(\"m_\", mun)) %&gt;%\n  pivot_wider(names_from = mun, values_from = cases) %&gt;%\n  select(-week) %&gt;%\n  # Use zero value for years withot week 53\n  mutate(across(everything(), ~replace_na(.x, 0))) %&gt;%\n  # Transpose as matrix\n  t() %&gt;%\n  # Convert object\n  tslist()\n\n`summarise()` has grouped output by 'mun', 'year'. You can override using the\n`.groups` argument.\n\n\n\nlength(tdengue)\n\n[1] 6111"
  },
  {
    "objectID": "dengue-cluster/cluster_mun_year.html#clustering",
    "href": "dengue-cluster/cluster_mun_year.html#clustering",
    "title": "Yearly time series",
    "section": "Clustering",
    "text": "Clustering\nSequence of k groups to be used.\n\nk_seq &lt;- 3:10\n\n\nSoft-DTW method\n\ntic()\nclust &lt;- tsclust(\n  series = tdengue, \n  type = \"partitional\", \n  k = k_seq,\n  distance = \"sdtw\",\n  seed = 12\n)\ntoc()\n\n186.312 sec elapsed\n\n\n\n\nCluster Validity Indices (CVI)\n\nnames(clust) &lt;- paste0(\"k_\", k_seq)\nres_cvi &lt;- sapply(clust, cvi, type = \"internal\") %&gt;% \n  t() %&gt;%\n  as_tibble(rownames = \"k\") %&gt;%\n  arrange(-Sil)\n\nres_cvi %&gt;%\n  kbl() %&gt;%\n  kable_styling()\n\n\n\n\nk\nSil\nSF\nCH\nDB\nDBstar\nD\nCOP\n\n\n\n\nk_7\n0.3042978\n0\n1498.9650\n1.643061\n2.034144\n-0.0090704\n0.1154715\n\n\nk_5\n0.3009208\n0\n1828.2539\n1.510974\n2.111730\n-0.0046130\n0.2050362\n\n\nk_3\n0.3000788\n0\n2147.2455\n1.141345\n1.363098\n-0.0037204\n0.2592231\n\n\nk_6\n0.2851064\n0\n1873.0643\n1.799201\n2.168677\n-0.0044977\n0.1324393\n\n\nk_8\n0.2586174\n0\n1636.1817\n2.149713\n3.552313\n-0.0065691\n0.1022790\n\n\nk_9\n0.2489799\n0\n958.2712\n3.232229\n3.805038\n-0.0057935\n0.1829836\n\n\nk_10\n0.2028457\n0\n1416.5421\n2.552099\n4.802588\n-0.0078132\n0.0904757\n\n\nk_4\n0.1600588\n0\n1613.0683\n2.871479\n4.394944\n-0.0054940\n0.2373967\n\n\n\n\n\n\n\n\n\nCluster with higher Silhouette statistic\n\nsel_clust &lt;- clust[[res_cvi[[1,1]]]]\n\n\nplot(sel_clust)\n\n\n\n\n\nggsave(filename = \"cluster_mun_year.pdf\")\n\nSaving 7 x 5 in image\n\n\n\nplot(sel_clust, type = \"centroids\", lty = 1)\n\n\n\n\n\nggsave(filename = \"cluster_mun_year_centr.pdf\")\n\nSaving 7 x 5 in image\n\n\n\n\nCluster sizes\n\ntable(sel_clust@cluster)\n\n\n   1    2    3    4    5    6    7 \n2008  895  551 1227  587  466  377"
  },
  {
    "objectID": "dengue-cluster/cluster_mun_year.html#session-info",
    "href": "dengue-cluster/cluster_mun_year.html#session-info",
    "title": "Yearly time series",
    "section": "Session info",
    "text": "Session info\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nRandom number generation:\n RNG:     L'Ecuyer-CMRG \n Normal:  Inversion \n Sample:  Rejection \n \nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] tictoc_1.2       kableExtra_1.3.4 dtwclust_5.5.12  dtw_1.23-1      \n [5] proxy_0.4-27     timetk_2.9.0     arrow_13.0.0.1   lubridate_1.9.3 \n [9] forcats_1.0.0    stringr_1.5.0    dplyr_1.1.3      purrr_1.0.2     \n[13] readr_2.1.4      tidyr_1.3.0      tibble_3.2.1     ggplot2_3.4.4   \n[17] tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n  [1] rlang_1.1.2         magrittr_2.0.3      clue_0.3-65        \n  [4] furrr_0.3.1         flexclust_1.4-1     compiler_4.3.2     \n  [7] systemfonts_1.0.5   vctrs_0.6.4         reshape2_1.4.4     \n [10] rvest_1.0.3         lhs_1.1.6           tune_1.1.2         \n [13] pkgconfig_2.0.3     fastmap_1.1.1       ellipsis_0.3.2     \n [16] labeling_0.4.3      utf8_1.2.4          promises_1.2.1     \n [19] rmarkdown_2.25      prodlim_2023.08.28  tzdb_0.4.0         \n [22] ragg_1.2.6          bit_4.0.5           xfun_0.41          \n [25] modeltools_0.2-23   jsonlite_1.8.7      recipes_1.0.8      \n [28] highr_0.10          later_1.3.1         parallel_4.3.2     \n [31] cluster_2.1.4       R6_2.5.1            stringi_1.7.12     \n [34] rsample_1.2.0       parallelly_1.36.0   rpart_4.1.21       \n [37] Rcpp_1.0.11         assertthat_0.2.1    dials_1.2.0        \n [40] iterators_1.0.14    knitr_1.45          future.apply_1.11.0\n [43] zoo_1.8-12          httpuv_1.6.12       Matrix_1.6-1.1     \n [46] splines_4.3.2       nnet_7.3-19         timechange_0.2.0   \n [49] tidyselect_1.2.0    rstudioapi_0.15.0   yaml_2.3.7         \n [52] timeDate_4022.108   codetools_0.2-19    listenv_0.9.0      \n [55] lattice_0.22-5      plyr_1.8.9          shiny_1.7.5.1      \n [58] withr_2.5.2         evaluate_0.23       future_1.33.0      \n [61] survival_3.5-7      RcppParallel_5.1.7  xml2_1.3.5         \n [64] xts_0.13.1          pillar_1.9.0        foreach_1.5.2      \n [67] stats4_4.3.2        shinyjs_2.1.0       generics_0.1.3     \n [70] hms_1.1.3           munsell_0.5.0       scales_1.2.1       \n [73] xtable_1.8-4        globals_0.16.2      class_7.3-22       \n [76] glue_1.6.2          tools_4.3.2         data.table_1.14.8  \n [79] RSpectra_0.16-1     webshot_0.5.5       gower_1.0.1        \n [82] grid_4.3.2          yardstick_1.2.0     ipred_0.9-14       \n [85] colorspace_2.1-0    cli_3.6.1           DiceDesign_1.9     \n [88] textshaping_0.3.7   workflows_1.1.3     parsnip_1.1.1      \n [91] fansi_1.0.5         viridisLite_0.4.2   svglite_2.1.2      \n [94] lava_1.7.3          gtable_0.3.4        GPfit_1.0-8        \n [97] digest_0.6.33       ggrepel_0.9.4       farver_2.1.1       \n[100] htmlwidgets_1.6.2   htmltools_0.5.7     lifecycle_1.0.4    \n[103] httr_1.4.7          hardhat_1.3.0       mime_0.12          \n[106] bit64_4.0.5         MASS_7.3-60"
  }
]