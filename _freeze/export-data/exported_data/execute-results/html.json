{
  "hash": "b0c78c5b99ceef70b2416bd203c05fe7",
  "result": {
    "markdown": "---\ntitle: \"Exported data\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(brpop)\nlibrary(piggyback)\n```\n:::\n\n\n## Dengue data\n\nTotal number of confirmed dengue cases, aggregated per municipality of residence and week of the first symptom's onset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_parquet(\"../dengue-data/parquet_aggregated/dengue_md.parquet\") %>%\n  group_by(mun) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", freq = sum(freq, na.rm = TRUE)) %>%\n  ungroup() %>%\n  rename(cases = freq)\n```\n:::\n\n\n## Population\n\nEstimated municipality population per year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop <- mun_pop_totals() %>%\n  filter(year %in% seq(year(min(dengue$date)), year(max(dengue$date)))) %>%\n  mutate(mun = as.character(mun))\n```\n:::\n\n\n## Human Development Index\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhdi <- read_parquet(\"../socioeconomic-data/hdi.parquet\") %>%\n  select(code_muni, hdi2010 = idhm2010)\n```\n:::\n\n\n## Weather data\n\nWeather indicators estimated by using zonal statistics of the territorial area of the municipality.\n\n### Precipitation\n\nTotal estimated precipitation, per municipality and week, in millimeter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprec <- open_dataset(sources = \"../weather-data/parquet/brdwgd/pr.parquet\") %>%\n  filter(name == \"pr_sum\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = sum(value, na.rm = TRUE)) %>%\n  rename(prec = value)\n```\n:::\n\n\n### Average maximun temperature\n\nAverage of maximum temperatures, per municipality and week, in celsius.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmax <- open_dataset(sources = \"../weather-data/parquet/brdwgd/tmax.parquet\") %>%\n  filter(name == \"Tmax_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmax = value)\n```\n:::\n\n\n### Average minimum temperature\n\nAverage of minimum temperatures, per municipality and week, in celsius.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmin <- open_dataset(sources = \"../weather-data/parquet/brdwgd/tmin.parquet\") %>%\n  filter(name == \"Tmin_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmin = value)\n```\n:::\n\n\n## Join data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data <- dengue %>%\n  mutate(dengue_year = year(date)) %>%\n  inner_join(pop, by = c(\"dengue_year\" = \"year\", \"mun\")) %>%\n  select(-dengue_year) %>%\n  inner_join(hdi, by = c(\"mun\" = \"code_muni\")) %>%\n  inner_join(prec, by = \"date\") %>%\n  inner_join(tmax, by = \"date\") %>%\n  inner_join(tmin, by = \"date\")\n```\n:::\n\n\n## Lag weather variables\n\nLag one and two weeks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data <- exp_data %>%\n  tk_augment_lags(.value = c(prec, tmax, tmin), .lags = 1:2)\n```\n:::\n\n\n## Overview\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(exp_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 2,202,058\nColumns: 14\n$ mun       <chr> \"110001\", \"110001\", \"110001\", \"110001\", \"110001\", \"110001\", …\n$ date      <date> 2011-03-13, 2011-03-20, 2011-03-27, 2011-04-03, 2011-04-10,…\n$ cases     <int> 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n$ pop       <int> 24737, 24737, 24737, 24737, 24737, 24737, 24737, 24737, 2473…\n$ hdi2010   <dbl> 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.64…\n$ prec      <dbl> 5977667, 5832714, 6581013, 6411878, 5538108, 4712170, 412114…\n$ tmax      <dbl> 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29.32273, …\n$ tmin      <dbl> 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19.37211, …\n$ prec_lag1 <dbl> NA, 5977667, 5832714, 6581013, 6411878, 5538108, 4712170, 41…\n$ tmax_lag1 <dbl> NA, 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29.322…\n$ tmin_lag1 <dbl> NA, 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19.372…\n$ prec_lag2 <dbl> NA, NA, 5977667, 5832714, 6581013, 6411878, 5538108, 4712170…\n$ tmax_lag2 <dbl> NA, NA, 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29…\n$ tmin_lag2 <dbl> NA, NA, 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19…\n```\n:::\n:::\n\n\nMunicipalities count: 5167\n\n## Export data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data %>% write_parquet(sink = \"exp_data.parquet\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data %>% write_csv(file = \"exp_data.csv\")\nzip::zip(zipfile = \"exp_data.csv.zip\", files = \"exp_data.csv\")\nunlink(x = \"exp_data.csv\")\n```\n:::\n\n\n## Data dictionary\n\n-   `mun` character. Municipality code with 6 digits\n\n-   `date` date. Date on format YYYY-MM-DD of the ceiling data of the week\n\n-   `cases` integer. Confirmed dengue cases count\n\n-   `pop` integer. Population estimation of the municipality\n\n-   `hdi2010` double. Human Development Index for 2010\n\n-   `prec` double. Total precipitation, mm\n\n-   `tmax` double. Average maximum temperature, Celsius\n\n-   `tmin` double. Average minimum temperature, Celsius\n\n-   `*_lag1` double. One week lagged variables\n\n-   `*_lag2` double. Two weeks lagged variables\n\n## Include on current GitHub release\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Files list to upload\nfiles_list <- c(\"exp_data.parquet\", \"exp_data.csv.zip\")\n\n# Upload files\nfor(i in files_list){\n  pb_upload(file = i, repo = \"rfsaldanha/dengue\", overwrite = TRUE)\n}\n```\n:::\n\n\nFiles `exp_data.parquet` and `exp_data.csv.zip` available on current release: <https://github.com/rfsaldanha/dengue/releases>\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.2 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0\nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] piggyback_0.1.4.9006 brpop_0.3.0          timetk_2.8.3        \n [4] arrow_12.0.1         lubridate_1.9.2      forcats_1.0.0       \n [7] stringr_1.5.0        dplyr_1.1.2          purrr_1.0.1         \n[10] readr_2.1.4          tidyr_1.3.0          tibble_3.2.1        \n[13] ggplot2_3.4.2        tidyverse_2.0.0     \n\nloaded via a namespace (and not attached):\n [1] xts_0.13.1          bit64_4.0.5         httr_1.4.6         \n [4] DiceDesign_1.9      gh_1.4.0            tools_4.1.2        \n [7] utf8_1.2.3          R6_2.5.1            rpart_4.1.16       \n[10] colorspace_2.1-0    yardstick_1.2.0     nnet_7.3-17        \n[13] withr_2.5.0         tidyselect_1.2.0    curl_5.0.1         \n[16] bit_4.0.5           compiler_4.1.2      httr2_0.2.3        \n[19] cli_3.6.1           scales_1.2.1        tune_1.1.1         \n[22] rappdirs_0.3.3      digest_0.6.31       rmarkdown_2.22     \n[25] pkgconfig_2.0.3     htmltools_0.5.5     parallelly_1.36.0  \n[28] lhs_1.1.6           fastmap_1.1.1       htmlwidgets_1.6.2  \n[31] rlang_1.1.1         rstudioapi_0.14     generics_0.1.3     \n[34] zoo_1.8-12          jsonlite_1.8.5      vroom_1.6.3        \n[37] zip_2.3.0           magrittr_2.0.3      Matrix_1.5-4.1     \n[40] Rcpp_1.0.10         munsell_0.5.0       fansi_1.0.4        \n[43] GPfit_1.0-8         lifecycle_1.0.3     furrr_0.3.1        \n[46] stringi_1.7.12      yaml_2.3.7          MASS_7.3-55        \n[49] recipes_1.0.6       grid_4.1.2          parallel_4.1.2     \n[52] listenv_0.9.0       crayon_1.5.2        lattice_0.20-45    \n[55] splines_4.1.2       hms_1.1.3           knitr_1.43         \n[58] pillar_1.9.0        dials_1.2.0         future.apply_1.11.0\n[61] codetools_0.2-18    parsnip_1.1.0       glue_1.6.2         \n[64] evaluate_0.21       rsample_1.1.1       data.table_1.14.8  \n[67] vctrs_0.6.3         tzdb_0.4.0          foreach_1.5.2      \n[70] gtable_0.3.3        future_1.32.0       assertthat_0.2.1   \n[73] cachem_1.0.8        xfun_0.39           gower_1.0.1        \n[76] mime_0.12           prodlim_2023.03.31  gitcreds_0.1.2     \n[79] class_7.3-20        survival_3.2-13     timeDate_4022.108  \n[82] iterators_1.0.14    memoise_2.0.1       hardhat_1.3.0      \n[85] lava_1.7.2.1        workflows_1.1.3     timechange_0.2.0   \n[88] globals_0.16.2      ipred_0.9-14       \n```\n:::\n:::\n",
    "supporting": [
      "exported_data_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}