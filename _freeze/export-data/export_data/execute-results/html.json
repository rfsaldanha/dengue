{
  "hash": "787558f7a0175046ad8a2ebf9f9cd986",
  "result": {
    "markdown": "---\ntitle: \"Export data\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(brpop)\nlibrary(piggyback)\n```\n:::\n\n\n## Dengue data\n\nTotal number of confirmed dengue cases, aggregated per municipality of residence and week of the first symptom's onset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_parquet(\"../dengue-data/parquet_aggregated/dengue_md.parquet\") %>%\n  group_by(mun) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", freq = sum(freq, na.rm = TRUE)) %>%\n  ungroup() %>%\n  rename(cases = freq)\n```\n:::\n\n\n## Population\n\nEstimated municipality population per year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop <- mun_pop_totals() %>%\n  filter(year %in% seq(year(min(dengue$date)), year(max(dengue$date)))) %>%\n  mutate(mun = as.character(mun))\n```\n:::\n\n\n## Human Development Index\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhdi <- read_parquet(\"../socioeconomic-data/hdi.parquet\") %>%\n  select(code_muni, hdi2010 = idhm2010)\n```\n:::\n\n\n## Weather data\n\nWeather indicators estimated by using zonal statistics of the territorial area of the municipality.\n\n### Precipitation\n\nTotal estimated precipitation, per municipality and week, in millimeter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprec <- open_dataset(sources = \"../weather-data/parquet/brdwgd/pr.parquet\") %>%\n  filter(name == \"pr_sum\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = sum(value, na.rm = TRUE)) %>%\n  rename(prec = value)\n```\n:::\n\n\n### Average maximun temperature\n\nAverage of maximum temperatures, per municipality and week, in celsius.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmax <- open_dataset(sources = \"../weather-data/parquet/brdwgd/tmax.parquet\") %>%\n  filter(name == \"Tmax_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmax = value)\n```\n:::\n\n\n### Average minimum temperature\n\nAverage of minimum temperatures, per municipality and week, in celsius.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmin <- open_dataset(sources = \"../weather-data/parquet/brdwgd/tmin.parquet\") %>%\n  filter(name == \"Tmin_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmin = value)\n```\n:::\n\n\n## Join data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data <- dengue %>%\n  mutate(dengue_year = year(date)) %>%\n  inner_join(pop, by = c(\"dengue_year\" = \"year\", \"mun\")) %>%\n  select(-dengue_year) %>%\n  inner_join(hdi, by = c(\"mun\" = \"code_muni\")) %>%\n  inner_join(prec, by = \"date\") %>%\n  inner_join(tmax, by = \"date\") %>%\n  inner_join(tmin, by = \"date\")\n```\n:::\n\n\n## Lag weather variables\n\nLag one and two weeks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data <- exp_data %>%\n  tk_augment_lags(.value = c(prec, tmax, tmin), .lags = 1:2)\n```\n:::\n\n\n## Overview\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(exp_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 2,202,058\nColumns: 14\n$ mun       <chr> \"110001\", \"110001\", \"110001\", \"110001\", \"110001\", \"110001\", …\n$ date      <date> 2011-03-13, 2011-03-20, 2011-03-27, 2011-04-03, 2011-04-10,…\n$ cases     <int> 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n$ pop       <int> 24737, 24737, 24737, 24737, 24737, 24737, 24737, 24737, 2473…\n$ hdi2010   <dbl> 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.641, 0.64…\n$ prec      <dbl> 5977667, 5832714, 6581013, 6411878, 5538108, 4712170, 412114…\n$ tmax      <dbl> 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29.32273, …\n$ tmin      <dbl> 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19.37211, …\n$ prec_lag1 <dbl> NA, 5977667, 5832714, 6581013, 6411878, 5538108, 4712170, 41…\n$ tmax_lag1 <dbl> NA, 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29.322…\n$ tmin_lag1 <dbl> NA, 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19.372…\n$ prec_lag2 <dbl> NA, NA, 5977667, 5832714, 6581013, 6411878, 5538108, 4712170…\n$ tmax_lag2 <dbl> NA, NA, 29.89511, 29.59591, 29.72916, 29.27960, 29.05301, 29…\n$ tmin_lag2 <dbl> NA, NA, 20.19973, 20.17791, 20.34251, 19.15049, 19.11662, 19…\n```\n:::\n:::\n\n\nMunicipalities count: 5167`\n\n## Export data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data %>% write_parquet(sink = \"exp_data.parquet\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_data %>% write_csv(file = \"exp_data.csv\")\nzip::zip(zipfile = \"exp_data.csv.zip\", files = \"exp_data.csv\")\nunlink(x = \"exp_data.csv\")\n```\n:::\n\n\n\n## Include on current GitHub release\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Files list to upload\nfiles_list <- c(\"exp_data.parquet\", \"exp_data.csv.zip\")\n\n# Upload files\nfor(i in files_list){\n  pb_upload(file = i, repo = \"rfsaldanha/dengue\", overwrite = TRUE)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npiggyback::pb_releases(repo = \"rfsaldanha/dengue\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     release_name release_id release_body        tag_name draft\n1 20230615_151011  108727577 Data release 20230615_151011 FALSE\n2 20230615_103834  108690448 Data release 20230615_103834 FALSE\n            created_at         published_at\n1 2023-06-15T13:08:31Z 2023-06-15T13:10:12Z\n2 2023-06-13T15:36:07Z 2023-06-15T08:38:35Z\n                                                           html_url\n1 https://github.com/rfsaldanha/dengue/releases/tag/20230615_151011\n2 https://github.com/rfsaldanha/dengue/releases/tag/20230615_103834\n                                                                                 upload_url\n1 https://uploads.github.com/repos/rfsaldanha/dengue/releases/108727577/assets{?name,label}\n2 https://uploads.github.com/repos/rfsaldanha/dengue/releases/108690448/assets{?name,label}\n  n_assets\n1        6\n2        4\n```\n:::\n:::\n\n\nFiles `exp_data.parquet` and `exp_data.csv.zip` available on current release: https://github.com/rfsaldanha/dengue/releases",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}