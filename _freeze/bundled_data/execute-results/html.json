{
  "hash": "6d44e051111e3041c4262aab9ed0e35c",
  "result": {
    "markdown": "---\ntitle: \"Bundled data\"\nauthor: \"Raphael Saldanha\"\ndate: last-modified\n---\n\n\nThis notebook prepares a data-set with dengue cases and covariates of interest per municipality.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(arrow)\nlibrary(brpop)\nlibrary(tidymodels)\nlibrary(timetk)\nsource(\"functions.R\")\n```\n:::\n\n\n## Data\n\n### Dengue\n\nLoad dengue cases data and aggregate per week.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_parquet(data_dir(\"dengue_data/parquet_aggregated/dengue_md.parquet\")) %>%\n  group_by(mun) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", freq = sum(freq, na.rm = TRUE)) %>%\n  ungroup() %>%\n  rename(cases = freq)\n```\n:::\n\n\n### Population\n\nLoad municipality population data for the years present at the dengue cases data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop <- mun_pop_totals() %>%\n  filter(year %in% seq(year(min(dengue$date)), year(max(dengue$date)))) %>%\n  mutate(mun = as.character(mun))\n\npop_2021 <- pop %>%\n  filter(year == 2021)\n\npop_2022 <- pop_2021 %>%\n  mutate(year = 2022)\n\npop <- bind_rows(pop, pop_2022)\n\nrm(pop_2021, pop_2022)\n```\n:::\n\n\n### Weather variables\n\nLoad weather variables and group per week.\n\n#### Precipitation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprec <- open_dataset(sources = data_dir(\"weather_data/parquet/era5/total_precipitation_sum.parquet\")) %>%\n  filter(name == \"total_precipitation_sum_sum\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = sum(value, na.rm = TRUE)) %>%\n  rename(prec = value)\n```\n:::\n\n\n::: callout-note\nAs precipitation is a volume, the `sum` function is used.\n:::\n\n#### Average maximum temperature\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmax <- open_dataset(sources = data_dir(\"weather_data/parquet/era5/2m_temperature_max.parquet\")) %>%\n  filter(name == \"2m_temperature_max_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmax = value)\n```\n:::\n\n\n#### Average minimum temperature\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmin <- open_dataset(sources = data_dir(\"weather_data/parquet/era5/2m_temperature_min.parquet\")) %>%\n  filter(name == \"2m_temperature_min_mean\") %>%\n  select(date, value) %>%\n  collect() %>%\n  filter(date >= min(dengue$date) & date <= max(dengue$date)) %>%\n  summarise_by_time(.date_var = date, .by = \"week\", value = mean(value, na.rm = TRUE)) %>%\n  rename(tmin = value)\n```\n:::\n\n\n### Join data\n\nJoin dengue cases, population and weather variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- dengue %>%\n  mutate(dengue_year = year(date)) %>%\n  inner_join(pop, by = c(\"dengue_year\" = \"year\", \"mun\")) %>%\n  select(-dengue_year) %>%\n  inner_join(prec, by = \"date\") %>%\n  inner_join(tmax, by = \"date\") %>%\n  inner_join(tmin, by = \"date\")\n\nrm(dengue, prec, tmax, tmin)\n```\n:::\n\n\n::: callout-note\nThe population estimate is constant over each year.\n:::\n\n### Cleaning and basic features\n\nDue the sparsity of dengue cases, only municipalities with more than 50,000 inhabitants are filtered.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# List municipalities with moren than 50k inhab\nmun_vec <- pop %>%\n  filter(year == max(year)) %>%\n  filter(pop >= 50000) %>%\n  pull(mun)\n\nrm(pop)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- tdengue %>%\n  # Remove municipalilities with zero population\n  filter(pop != 0) %>%\n  # Keep only municipalities in the list\n   filter(mun %in% mun_vec) %>%\n  # Compute dengue rate per population\n  # mutate(cases = cases/pop*100000) %>%\n  # Remove population\n  select(-pop) %>%\n  # Round values\n  mutate(across(c(cases, prec, tmax, tmin), ~ round(.x, digits = 2))) %>%\n  # Pad weeks \n  group_by(mun) %>%\n  pad_by_time(date, .by = \"week\", .pad_value = 0, .start_date = min(tdengue$date), .end_date = max(tdengue$date)) %>%\n  ungroup()\n```\n:::\n\n\nMunicipalities remaining at the dataset: 678\n\n::: callout-warning\nThe computation of dengue incidence (cases per population) is commented to keep the raw cases count.\n:::\n\n### Standardize measures\n\nCenter around mean with a unit standard deviation.\n\n$$\nx' = \\frac{x - \\mu}{\\sigma} \n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- tdengue %>%\n  mutate(cases_raw = cases) %>%\n  group_by(mun) %>%\n  arrange(date) %>%\n  mutate(cases_cum_raw = cumsum(cases_raw)) %>%\n  mutate(cases_cum = cases_cum_raw) %>%\n  mutate(across(c(cases, cases_cum, prec, tmax, tmin), ~ standardize_vec(.x, silent = TRUE))) %>%\n  ungroup()\n```\n:::\n\n\n### Lag and rolling lag variables\n\nCreates lagged variables from standardized dengue cases and weather variables, from 1 to 6 weeks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- tdengue %>%\n  group_by(mun) %>%\n  tk_augment_lags(.value = c(cases, prec, tmax, tmin), .lags = 1:6) %>%\n  # tk_augment_slidify(\n  #   .value = contains(\"_lag\"), \n  #   .period = c(2, 4, 6), \n  #   .f = ~ mean(.x, na.rm = TRUE), \n  #   .partial = TRUE,\n  #   .align   = \"center\"\n  # ) %>%\n  ungroup()\n```\n:::\n\n\n::: callout-warning\nRolling window calculation procedure is commented out.\n:::\n\n## Overview\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(tdengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 424,428\nColumns: 33\n$ mun           <chr> \"110002\", \"110002\", \"110002\", \"110002\", \"110002\", \"11000…\n$ date          <date> 2011-01-02, 2011-01-09, 2011-01-16, 2011-01-23, 2011-01…\n$ cases         <dbl> -0.265989, -0.265989, -0.265989, -0.265989, -0.265989, -…\n$ prec          <dbl> -0.9029202, -0.9029202, -0.9029202, -0.9029202, -0.90292…\n$ tmax          <dbl> -1.185467, -1.185467, -1.185467, -1.185467, -1.185467, -…\n$ tmin          <dbl> -1.18545, -1.18545, -1.18545, -1.18545, -1.18545, -1.185…\n$ cases_raw     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ cases_cum_raw <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ cases_cum     <dbl> -0.5455219, -0.5455219, -0.5455219, -0.5455219, -0.54552…\n$ cases_lag1    <dbl> NA, -0.265989, -0.265989, -0.265989, -0.265989, -0.26598…\n$ prec_lag1     <dbl> NA, -0.9029202, -0.9029202, -0.9029202, -0.9029202, -0.9…\n$ tmax_lag1     <dbl> NA, -1.185467, -1.185467, -1.185467, -1.185467, -1.18546…\n$ tmin_lag1     <dbl> NA, -1.18545, -1.18545, -1.18545, -1.18545, -1.18545, -1…\n$ cases_lag2    <dbl> NA, NA, -0.265989, -0.265989, -0.265989, -0.265989, -0.2…\n$ prec_lag2     <dbl> NA, NA, -0.9029202, -0.9029202, -0.9029202, -0.9029202, …\n$ tmax_lag2     <dbl> NA, NA, -1.185467, -1.185467, -1.185467, -1.185467, -1.1…\n$ tmin_lag2     <dbl> NA, NA, -1.18545, -1.18545, -1.18545, -1.18545, -1.18545…\n$ cases_lag3    <dbl> NA, NA, NA, -0.265989, -0.265989, -0.265989, -0.265989, …\n$ prec_lag3     <dbl> NA, NA, NA, -0.9029202, -0.9029202, -0.9029202, -0.90292…\n$ tmax_lag3     <dbl> NA, NA, NA, -1.185467, -1.185467, -1.185467, -1.185467, …\n$ tmin_lag3     <dbl> NA, NA, NA, -1.18545, -1.18545, -1.18545, -1.18545, -1.1…\n$ cases_lag4    <dbl> NA, NA, NA, NA, -0.265989, -0.265989, -0.265989, -0.2659…\n$ prec_lag4     <dbl> NA, NA, NA, NA, -0.9029202, -0.9029202, -0.9029202, -0.9…\n$ tmax_lag4     <dbl> NA, NA, NA, NA, -1.185467, -1.185467, -1.185467, -1.1854…\n$ tmin_lag4     <dbl> NA, NA, NA, NA, -1.18545, -1.18545, -1.18545, -1.18545, …\n$ cases_lag5    <dbl> NA, NA, NA, NA, NA, -0.265989, -0.265989, -0.265989, -0.…\n$ prec_lag5     <dbl> NA, NA, NA, NA, NA, -0.9029202, -0.9029202, -0.9029202, …\n$ tmax_lag5     <dbl> NA, NA, NA, NA, NA, -1.185467, -1.185467, -1.185467, -1.…\n$ tmin_lag5     <dbl> NA, NA, NA, NA, NA, -1.18545, -1.18545, -1.18545, -1.185…\n$ cases_lag6    <dbl> NA, NA, NA, NA, NA, NA, -0.265989, -0.265989, -0.265989,…\n$ prec_lag6     <dbl> NA, NA, NA, NA, NA, NA, -0.9029202, -0.9029202, -0.90292…\n$ tmax_lag6     <dbl> NA, NA, NA, NA, NA, NA, -1.185467, -1.185467, -1.185467,…\n$ tmin_lag6     <dbl> NA, NA, NA, NA, NA, NA, -1.18545, -1.18545, -1.18545, -1…\n```\n:::\n:::\n\n\n## Save result\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_parquet(x = tdengue, sink = data_dir(\"bundled_data/tdengue.parquet\"))\n```\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.4 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] timetk_2.9.0       yardstick_1.3.0    workflowsets_1.0.1 workflows_1.1.3   \n [5] tune_1.1.2         rsample_1.2.0      recipes_1.0.10     parsnip_1.2.0     \n [9] modeldata_1.3.0    infer_1.0.6        dials_1.2.0        scales_1.3.0      \n[13] broom_1.0.5        tidymodels_1.1.1   brpop_0.3.0        arrow_14.0.0.2    \n[17] lubridate_1.9.3    forcats_1.0.0      stringr_1.5.1      dplyr_1.1.4       \n[21] purrr_1.0.2        readr_2.1.5        tidyr_1.3.1        tibble_3.2.1      \n[25] ggplot2_3.4.4      tidyverse_2.0.0   \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.0    timeDate_4032.109   fastmap_1.1.1      \n [4] digest_0.6.34       rpart_4.1.23        timechange_0.3.0   \n [7] lifecycle_1.0.4     survival_3.5-7      magrittr_2.0.3     \n[10] compiler_4.3.2      rlang_1.1.3         tools_4.3.2        \n[13] utf8_1.2.4          yaml_2.3.8          data.table_1.15.0  \n[16] knitr_1.45          htmlwidgets_1.6.4   bit_4.0.5          \n[19] DiceDesign_1.10     withr_3.0.0         nnet_7.3-19        \n[22] grid_4.3.2          fansi_1.0.6         xts_0.13.2         \n[25] colorspace_2.1-0    future_1.33.1       iterators_1.0.14   \n[28] globals_0.16.2      MASS_7.3-60         anytime_0.3.9      \n[31] cli_3.6.2           rmarkdown_2.25      generics_0.1.3     \n[34] rstudioapi_0.15.0   future.apply_1.11.1 tzdb_0.4.0         \n[37] splines_4.3.2       assertthat_0.2.1    parallel_4.3.2     \n[40] vctrs_0.6.5         hardhat_1.3.1       Matrix_1.6-3       \n[43] jsonlite_1.8.8      hms_1.1.3           bit64_4.0.5        \n[46] listenv_0.9.1       foreach_1.5.2       gower_1.0.1        \n[49] glue_1.7.0          parallelly_1.37.0   codetools_0.2-19   \n[52] stringi_1.8.3       gtable_0.3.4        GPfit_1.0-8        \n[55] munsell_0.5.0       pillar_1.9.0        furrr_0.3.1        \n[58] htmltools_0.5.7     ipred_0.9-14        lava_1.7.3         \n[61] R6_2.5.1            lhs_1.1.6           evaluate_0.23      \n[64] lattice_0.22-5      backports_1.4.1     class_7.3-22       \n[67] Rcpp_1.0.12         prodlim_2023.08.28  padr_0.6.2         \n[70] xfun_0.42           zoo_1.8-12          pkgconfig_2.0.3    \n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}