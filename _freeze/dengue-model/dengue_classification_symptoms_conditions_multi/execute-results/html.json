{
  "hash": "17a89e62ebc456682cdc1a6197d45fc1",
  "result": {
    "markdown": "---\ntitle: \"Dengue case classification\"\nsubtitle: \"by symptoms and clinical condition\"\nauthor: Raphael Saldanha\ndate: now\n---\n\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(arrow)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'arrow'\n\nThe following object is masked from 'package:lubridate':\n\n    duration\n\nThe following object is masked from 'package:utils':\n\n    timestamp\n```\n:::\n\n```{.r .cell-code}\nlibrary(knitr)\nlibrary(lubridate)\nlibrary(tidymodels)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ────────────────────────────────────── tidymodels 1.1.0 ──\n✔ broom        1.0.5     ✔ rsample      1.1.1\n✔ dials        1.2.0     ✔ tune         1.1.1\n✔ infer        1.0.4     ✔ workflows    1.1.3\n✔ modeldata    1.1.0     ✔ workflowsets 1.0.1\n✔ parsnip      1.1.0     ✔ yardstick    1.2.0\n✔ recipes      1.0.6     \n── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──\n✖ scales::discard() masks purrr::discard()\n✖ dplyr::filter()   masks stats::filter()\n✖ recipes::fixed()  masks stringr::fixed()\n✖ dplyr::lag()      masks stats::lag()\n✖ yardstick::spec() masks readr::spec()\n✖ recipes::step()   masks stats::step()\n• Use suppressPackageStartupMessages() to eliminate package startup messages\n```\n:::\n\n```{.r .cell-code}\nlibrary(finetune)\nlibrary(tictoc)\nlibrary(vip)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'vip'\n\nThe following object is masked from 'package:utils':\n\n    vi\n```\n:::\n:::\n\n\n## Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Data sources\nfiles_list <- c(\n  \"../dengue-data/parquets/dengue_2016.parquet\",\n  \"../dengue-data/parquets/dengue_2017.parquet\",\n  \"../dengue-data/parquets/dengue_2018.parquet\",\n  \"../dengue-data/parquets/dengue_2019.parquet\",\n  \"../dengue-data/parquets/dengue_2020.parquet\",\n  \"../dengue-data/parquets/dengue_2021.parquet\"\n)\n\n# Independent variables\nx_vars <- c(\"FEBRE\", \"MIALGIA\", \"CEFALEIA\", \n            \"EXANTEMA\", \"VOMITO\", \"NAUSEA\", \n            \"DOR_COSTAS\", \"CONJUNTVIT\", \n            \"ARTRITE\", \"ARTRALGIA\", \"PETEQUIA_N\", \n            \"LEUCOPENIA\", \"LACO\", \"DOR_RETRO\", \n            \"DIABETES\", \"HEMATOLOG\", \"HEPATOPAT\", \n            \"HEPATOPAT\", \"RENAL\", \"HIPERTENSA\",\n            \"ACIDO_PEPT\", \"AUTO_IMUNE\")\n\n# Prepare data\ndengue <- arrow::open_dataset(sources = files_list) %>%\n  # Select variables\n  select(all_of(c(\"CLASSI_FIN\", \"COMUNINF\", \"DT_SIN_PRI\", x_vars))) %>%\n  # Filter out \"Inconclusivo\" cases\n  filter(CLASSI_FIN != \"Inconclusivo\") %>%\n  # Collect data from parquet files\n  collect() %>%\n  # Prepare variables\n  mutate(CLASSI_FIN = case_when(\n    CLASSI_FIN != \"Descartado\" ~ TRUE,\n    .default = FALSE\n  )) %>%\n  mutate(CLASSI_FIN = as.factor(CLASSI_FIN)) %>%\n  mutate(DT_SIN_PRI = as_date(DT_SIN_PRI)) %>%\n  mutate(COMUNINF = as.factor(COMUNINF)) %>%\n  mutate_at(.vars = x_vars, .funs = ~ . == \"Sim\") \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Smaller dataset for tests\ndengue <- sample_n(dengue, 100000)\n```\n:::\n\n\n## Modeling\n\n### Train and test dataset split\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n\ndengue_split <- dengue %>%\n  initial_split(strata = CLASSI_FIN)\n\ndengue_train <- training(dengue_split)\ndengue_test <- testing(dengue_split)\n\nset.seed(234)\ndengue_folds <- vfold_cv(dengue_train, strata = CLASSI_FIN)\n```\n:::\n\n\n### Recipes\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# All variables\ndengue_rec_1 <- \n  recipe(CLASSI_FIN ~ . , data = dengue_train) %>%\n  step_date(DT_SIN_PRI, features = c(\"month\", \"week\", \"semester\", \"quarter\"), keep_original_cols = FALSE) %>%\n  step_integer(all_predictors())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Without municipality code\ndengue_rec_2 <- dengue_rec_1 %>%\n  step_rm(COMUNINF)\n```\n:::\n\n\n### Specifications\n\n#### XGB\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxgb_spec <-\n  boost_tree(\n    trees = tune(),\n    min_n = tune(),\n    mtry = tune(),\n    learn_rate = 0.01\n  ) %>%\n  set_engine(\"xgboost\") %>%\n  set_mode(\"classification\")\n```\n:::\n\n\n#### Decision tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncart_spec <-\n  decision_tree(\n    cost_complexity = tune(), \n    min_n = tune()\n  ) %>% \n  set_engine(\"rpart\") %>% \n  set_mode(\"classification\")\n```\n:::\n\n\n### Workflows\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_workflows <- \n  workflow_set(\n    preproc = list(recipe_1 = dengue_rec_1, recipe_2 = dengue_rec_2),\n    models = list(xgb = xgb_spec, cart = cart_spec)\n  )\n```\n:::\n\n\n### Tuning\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndoParallel::registerDoParallel()\n\nrace_ctrl <-\n   control_race(\n      save_pred = TRUE,\n      parallel_over = \"everything\",\n      save_workflow = TRUE\n   )\n\ntic()\nrace_results <- \n  all_workflows %>%\n  workflow_map(\n    \"tune_race_anova\",\n    seed = 345,\n    resamples = dengue_folds,\n    grid = 15,\n    control = race_ctrl\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\ni Creating pre-processing data to finalize unknown parameter: mtry\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\ni Creating pre-processing data to finalize unknown parameter: mtry\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\nℹ The workflow being saved contains a recipe, which is 7.48 Mb in ℹ memory. If\nthis was not intentional, please set the control setting ℹ `save_workflow =\nFALSE`.\n```\n:::\n\n```{.r .cell-code}\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n1622.714 sec elapsed\n```\n:::\n:::\n\n\n#### Race metrics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_rank_results <- rank_results(race_results, rank_metric = \"roc_auc\")\n\ntrain_rank_results\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 18 × 9\n   wflow_id      .config    .metric  mean std_err     n preprocessor model  rank\n   <chr>         <chr>      <chr>   <dbl>   <dbl> <int> <chr>        <chr> <int>\n 1 recipe_1_xgb  Preproces… accura… 0.846 0.00101    10 recipe       boos…     1\n 2 recipe_1_xgb  Preproces… roc_auc 0.903 0.00101    10 recipe       boos…     1\n 3 recipe_1_xgb  Preproces… accura… 0.845 0.00103    10 recipe       boos…     2\n 4 recipe_1_xgb  Preproces… roc_auc 0.903 0.00108    10 recipe       boos…     2\n 5 recipe_1_cart Preproces… accura… 0.636 0.00204    10 recipe       deci…     3\n 6 recipe_1_cart Preproces… roc_auc 0.678 0.00233    10 recipe       deci…     3\n 7 recipe_2_xgb  Preproces… accura… 0.631 0.00153    10 recipe       boos…     4\n 8 recipe_2_xgb  Preproces… roc_auc 0.651 0.00198    10 recipe       boos…     4\n 9 recipe_2_xgb  Preproces… accura… 0.631 0.00172    10 recipe       boos…     5\n10 recipe_2_xgb  Preproces… roc_auc 0.651 0.00207    10 recipe       boos…     5\n11 recipe_2_xgb  Preproces… accura… 0.630 0.00180    10 recipe       boos…     6\n12 recipe_2_xgb  Preproces… roc_auc 0.651 0.00201    10 recipe       boos…     6\n13 recipe_2_xgb  Preproces… accura… 0.630 0.00156    10 recipe       boos…     7\n14 recipe_2_xgb  Preproces… roc_auc 0.651 0.00204    10 recipe       boos…     7\n15 recipe_2_xgb  Preproces… accura… 0.630 0.00160    10 recipe       boos…     8\n16 recipe_2_xgb  Preproces… roc_auc 0.650 0.00200    10 recipe       boos…     8\n17 recipe_2_cart Preproces… accura… 0.624 0.00170    10 recipe       deci…     9\n18 recipe_2_cart Preproces… roc_auc 0.636 0.00186    10 recipe       deci…     9\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(race_results, metric = \"roc_auc\")\n```\n\n::: {.cell-output-display}\n![](dengue_classification_symptoms_conditions_multi_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Last fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\nselection_train <- train_rank_results %>%\n  arrange(-mean) %>%\n  pull(wflow_id) %>%\n  first()\n\nselection_train\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"recipe_1_xgb\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbest_results <- race_results %>%\n  extract_workflow_set_result(selection_train) %>%\n  select_best(\"accuracy\")\n\nbest_results\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 4\n   mtry trees min_n .config              \n  <int> <int> <int> <chr>                \n1     8  1536    11 Preprocessor1_Model05\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlast_fit <- race_results %>%\n  extract_workflow(selection_train) %>%\n  finalize_workflow(best_results) %>%\n  last_fit(dengue_split)\n```\n:::\n\n\n### Evaluate on test\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncollect_metrics(last_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 4\n  .metric  .estimator .estimate .config             \n  <chr>    <chr>          <dbl> <chr>               \n1 accuracy binary         0.848 Preprocessor1_Model1\n2 roc_auc  binary         0.903 Preprocessor1_Model1\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncollect_predictions(last_fit) %>%\n    conf_mat(CLASSI_FIN, .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          Truth\nPrediction FALSE  TRUE\n     FALSE 10414  3561\n     TRUE    237 10789\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlast_fit %>%\n  extract_fit_engine() %>%\n  vip()\n```\n\n::: {.cell-output-display}\n![](dengue_classification_symptoms_conditions_multi_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.2 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0\nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] rpart_4.1.16       rlang_1.1.1        xgboost_1.7.5.1    vip_0.3.2         \n [5] tictoc_1.2         finetune_1.1.0     yardstick_1.2.0    workflowsets_1.0.1\n [9] workflows_1.1.3    tune_1.1.1         rsample_1.1.1      recipes_1.0.6     \n[13] parsnip_1.1.0      modeldata_1.1.0    infer_1.0.4        dials_1.2.0       \n[17] scales_1.2.1       broom_1.0.5        tidymodels_1.1.0   knitr_1.43        \n[21] arrow_12.0.1       lubridate_1.9.2    forcats_1.0.0      stringr_1.5.0     \n[25] dplyr_1.1.2        purrr_1.0.1        readr_2.1.4        tidyr_1.3.0       \n[29] tibble_3.2.1       ggplot2_3.4.2      tidyverse_2.0.0   \n\nloaded via a namespace (and not attached):\n [1] nlme_3.1-155        bit64_4.0.5         doParallel_1.0.17  \n [4] DiceDesign_1.9      tools_4.1.2         backports_1.4.1    \n [7] utf8_1.2.3          R6_2.5.1            colorspace_2.1-0   \n[10] nnet_7.3-17         withr_2.5.0         clock_0.7.0        \n[13] gridExtra_2.3       tidyselect_1.2.0    bit_4.0.5          \n[16] compiler_4.1.2      cli_3.6.1           labeling_0.4.2     \n[19] digest_0.6.31       minqa_1.2.5         rmarkdown_2.22     \n[22] pkgconfig_2.0.3     htmltools_0.5.5     lme4_1.1-33        \n[25] parallelly_1.36.0   lhs_1.1.6           fastmap_1.1.1      \n[28] htmlwidgets_1.6.2   rstudioapi_0.14     farver_2.1.1       \n[31] generics_0.1.3      jsonlite_1.8.5      magrittr_2.0.3     \n[34] Matrix_1.5-4.1      Rcpp_1.0.10         munsell_0.5.0      \n[37] fansi_1.0.4         GPfit_1.0-8         lifecycle_1.0.3    \n[40] furrr_0.3.1         stringi_1.7.12      yaml_2.3.7         \n[43] MASS_7.3-55         grid_4.1.2          parallel_4.1.2     \n[46] listenv_0.9.0       lattice_0.20-45     splines_4.1.2      \n[49] hms_1.1.3           pillar_1.9.0        boot_1.3-28        \n[52] future.apply_1.11.0 codetools_0.2-18    glue_1.6.2         \n[55] evaluate_0.21       data.table_1.14.8   nloptr_2.0.3       \n[58] vctrs_0.6.3         tzdb_0.4.0          foreach_1.5.2      \n[61] gtable_0.3.3        future_1.32.0       assertthat_0.2.1   \n[64] xfun_0.39           gower_1.0.1         prodlim_2023.03.31 \n[67] class_7.3-20        survival_3.2-13     timeDate_4022.108  \n[70] iterators_1.0.14    hardhat_1.3.0       lava_1.7.2.1       \n[73] timechange_0.2.0    globals_0.16.2      ellipsis_0.3.2     \n[76] ipred_0.9-14       \n```\n:::\n:::\n",
    "supporting": [
      "dengue_classification_symptoms_conditions_multi_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}