{
  "hash": "968f7e1d30efd52297029cf476e7ef0f",
  "result": {
    "markdown": "---\ntitle: \"Multivariate clustering\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\nThis notebook aims to cluster the Brazilian municipalities considering climate indicators with multivariate clustering techniques.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(dtwclust)\nlibrary(kableExtra)\nlibrary(tictoc)\nlibrary(sf)\nsource(\"../functions.R\")\n```\n:::\n\n\n## Load data\n\nDaily, scaled maximum temperature, minimum temperature and precipitation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- open_dataset(sources = data_dir(\"bundled_data/tdengue.parquet\")) %>%\n  select(mun, date, tmax, tmin, prec) %>%\n  collect()\n\ndim(tdengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 340179      5\n```\n:::\n:::\n\n\nData for maps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nuf_sf <- geobr::read_state(showProgress = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nUsing year 2010\n```\n:::\n\n```{.r .cell-code}\ncoords <- geobr::read_municipality(showProgress = FALSE) %>%\n  st_make_valid() %>%\n  st_centroid()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nUsing year 2010\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n:::\n:::\n\n\n## Prepare data\n\nFor clustering, the data must be a list of data frames with climate data and without date.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngdengue <- tdengue %>%\n  group_by(mun) %>%\n  arrange(date) %>%\n  select(-date)\n\nmdengue <- group_split(gdengue, .keep = FALSE) %>%\n  tslist(simplify = TRUE)\n\nnames(mdengue) <- group_keys(gdengue)$mun\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(mdengue[1:3])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 3\n $ 110002: num [1:501, 1:3] -13.182 0.285 0.37 0.491 0.697 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:3] \"tmax\" \"tmin\" \"prec\"\n $ 110004: num [1:501, 1:3] -13.182 0.285 0.37 0.491 0.697 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:3] \"tmax\" \"tmin\" \"prec\"\n $ 110011: num [1:501, 1:3] -8.48 -8.48 -8.48 -8.48 -8.48 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ : NULL\n  .. ..$ : chr [1:3] \"tmax\" \"tmin\" \"prec\"\n```\n:::\n:::\n\n\n## SDTW clustering\n\nTry from 2 to 20 partitions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nstdw_clust <- tsclust(\n  series = mdengue, \n  type = \"partitional\", k = 2:20, \n  distance = \"dtw_basic\", \n  seed = 13\n)\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n6930.239 sec elapsed\n```\n:::\n:::\n\n\n### Cluster Validity Indices (CVI)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(stdw_clust) <- paste0(\"k_\", 2:20)\nres_cvi <- sapply(stdw_clust, cvi, type = \"internal\") %>% \n  t() %>%\n  as_tibble(rownames = \"k\") %>%\n  arrange(-Sil)\n\nres_cvi\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 19 × 8\n   k       Sil    SF    CH    DB DBstar       D    COP\n   <chr> <dbl> <dbl> <dbl> <dbl>  <dbl>   <dbl>  <dbl>\n 1 k_18  0.890     0  435. 0.576  3.90  0.0286  0.0140\n 2 k_20  0.888     0  486. 0.532  3.97  0.0273  0.0109\n 3 k_14  0.881     0  443. 0.677  2.93  0.0216  0.0184\n 4 k_15  0.874     0  473. 1.03   2.38  0.0208  0.0160\n 5 k_16  0.872     0  455. 0.734  2.27  0.00540 0.0155\n 6 k_19  0.862     0  443. 0.578  2.37  0.0171  0.0129\n 7 k_13  0.832     0  447. 0.900  2.23  0.0153  0.0201\n 8 k_12  0.825     0  437. 0.698  1.98  0.0253  0.0227\n 9 k_10  0.820     0  513. 0.570  1.76  0.0253  0.0241\n10 k_9   0.755     0  383. 1.32   2.43  0.0184  0.0375\n11 k_8   0.751     0  371. 0.675  1.94  0.0335  0.0433\n12 k_17  0.700     0  209. 3.81   8.40  0.0124  0.0318\n13 k_11  0.673     0  297. 1.54   3.30  0.0124  0.0367\n14 k_6   0.669     0  391. 0.959  1.88  0.0245  0.0567\n15 k_4   0.608     0  444. 0.947  1.70  0.0245  0.0906\n16 k_5   0.603     0  399. 1.17   1.99  0.0124  0.0678\n17 k_3   0.600     0  321. 0.763  0.905 0.0418  0.115 \n18 k_7   0.449     0  164. 1.83   4.76  0.0124  0.0858\n19 k_2   0.276     0  475. 0.773  0.773 0.103   0.985 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm_sel_clust <- stdw_clust[[res_cvi[[1,1]]]]\n\nplot(m_sel_clust)\n```\n\n::: {.cell-output-display}\n![](cluster_multivariate_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n### Partitions size\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(m_sel_clust@cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18 \n230   7  33  17 143  18  43  11  13  54   4  20  26  11   2  12  14  21 \n```\n:::\n:::\n\n\n### Map\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- coords %>%\n  mutate(code_muni = substr(code_muni, 0, 6))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm_cluster_ids <- tibble(\n  code_muni = names(mdengue),\n  group = as.character(m_sel_clust@cluster)\n) %>% \n  left_join(coords, by = \"code_muni\") %>%\n  arrange(group, name_muni) %>%\n  st_as_sf()\n\nm_cluster_ids\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 679 features and 5 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -72.7546 ymin: -32.2198 xmax: -34.84751 ymax: 3.117846\nGeodetic CRS:  SIRGAS 2000\n# A tibble: 679 × 6\n   code_muni group name_muni   code_state abbrev_state                   geom\n   <chr>     <chr> <chr>       <chr>      <chr>                   <POINT [°]>\n 1 260005    1     Abreu E Li… 26         PE            (-35.01961 -7.879305)\n 2 230020    1     Acaraú      23         CE            (-40.08916 -2.967873)\n 3 150040    1     Alenquer    15         PA           (-55.03927 -0.6042975)\n 4 510025    1     Alta Flore… 51         MT             (-56.3664 -10.05536)\n 5 350160    1     Americana   35         SP             (-47.2891 -22.72336)\n 6 330010    1     Angra Dos … 33         RJ             (-44.35303 -22.9867)\n 7 520110    1     Anápolis    52         GO            (-48.97364 -16.29054)\n 8 230100    1     Aquiraz     23         CE            (-38.39444 -3.976426)\n 9 230110    1     Aracati     23         CE            (-37.68685 -4.680357)\n10 270030    1     Arapiraca   27         AL            (-36.64175 -9.749339)\n# ℹ 669 more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = uf_sf, fill = \"lightgray\", color = \"grey20\", size=.15, show.legend = FALSE) +\n  geom_sf(data = m_cluster_ids, aes(color = group), size = 2) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](cluster_multivariate_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nRandom number generation:\n RNG:     L'Ecuyer-CMRG \n Normal:  Inversion \n Sample:  Rejection \n \nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] sf_1.0-14        tictoc_1.2       kableExtra_1.3.4 dtwclust_5.5.12 \n [5] dtw_1.23-1       proxy_0.4-27     timetk_2.9.0     arrow_14.0.0    \n [9] lubridate_1.9.3  forcats_1.0.0    stringr_1.5.1    dplyr_1.1.4     \n[13] purrr_1.0.2      readr_2.1.4      tidyr_1.3.0      tibble_3.2.1    \n[17] ggplot2_3.4.4    tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n  [1] DBI_1.1.3           s2_1.1.4            rlang_1.1.2        \n  [4] magrittr_2.0.3      clue_0.3-65         furrr_0.3.1        \n  [7] flexclust_1.4-1     e1071_1.7-13        compiler_4.3.2     \n [10] systemfonts_1.0.5   vctrs_0.6.4         reshape2_1.4.4     \n [13] rvest_1.0.3         lhs_1.1.6           tune_1.1.2         \n [16] wk_0.9.0            pkgconfig_2.0.3     fastmap_1.1.1      \n [19] ellipsis_0.3.2      labeling_0.4.3      utf8_1.2.4         \n [22] promises_1.2.1      rmarkdown_2.25      prodlim_2023.08.28 \n [25] tzdb_0.4.0          bit_4.0.5           xfun_0.41          \n [28] modeltools_0.2-23   jsonlite_1.8.7      recipes_1.0.8      \n [31] later_1.3.1         parallel_4.3.2      cluster_2.1.4      \n [34] R6_2.5.1            stringi_1.8.1       rsample_1.2.0      \n [37] parallelly_1.36.0   rpart_4.1.21        Rcpp_1.0.11        \n [40] assertthat_0.2.1    dials_1.2.0         iterators_1.0.14   \n [43] knitr_1.45          future.apply_1.11.0 zoo_1.8-12         \n [46] httpuv_1.6.12       Matrix_1.6-2        splines_4.3.2      \n [49] nnet_7.3-19         timechange_0.2.0    tidyselect_1.2.0   \n [52] rstudioapi_0.15.0   yaml_2.3.7          timeDate_4022.108  \n [55] codetools_0.2-19    curl_5.1.0          listenv_0.9.0      \n [58] lattice_0.22-5      plyr_1.8.9          shiny_1.8.0        \n [61] withr_2.5.2         evaluate_0.23       future_1.33.0      \n [64] survival_3.5-7      units_0.8-4         RcppParallel_5.1.7 \n [67] xml2_1.3.5          xts_0.13.1          pillar_1.9.0       \n [70] KernSmooth_2.23-22  foreach_1.5.2       stats4_4.3.2       \n [73] shinyjs_2.1.0       generics_0.1.3      hms_1.1.3          \n [76] munsell_0.5.0       scales_1.2.1        xtable_1.8-4       \n [79] globals_0.16.2      class_7.3-22        glue_1.6.2         \n [82] tools_4.3.2         data.table_1.14.8   RSpectra_0.16-1    \n [85] webshot_0.5.5       gower_1.0.1         grid_4.3.2         \n [88] yardstick_1.2.0     ipred_0.9-14        colorspace_2.1-0   \n [91] geobr_1.8.1         cli_3.6.1           DiceDesign_1.9     \n [94] workflows_1.1.3     parsnip_1.1.1       fansi_1.0.5        \n [97] viridisLite_0.4.2   svglite_2.1.2       lava_1.7.3         \n[100] gtable_0.3.4        GPfit_1.0-8         digest_0.6.33      \n[103] classInt_0.4-10     ggrepel_0.9.4       farver_2.1.1       \n[106] htmlwidgets_1.6.2   htmltools_0.5.7     lifecycle_1.0.4    \n[109] httr_1.4.7          hardhat_1.3.0       mime_0.12          \n[112] bit64_4.0.5         MASS_7.3-60        \n```\n:::\n:::\n",
    "supporting": [
      "cluster_multivariate_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}