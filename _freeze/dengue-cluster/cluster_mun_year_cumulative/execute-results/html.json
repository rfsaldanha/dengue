{
  "hash": "ec52b8dae25b3b77d0be6c8233384ef9",
  "result": {
    "markdown": "---\ntitle: \"Cumulative time series\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\nThis notebook aims to cluster the Brazilian municipalities cumulative yearly dengue cases time-series yearly by its similarities.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(dtwclust)\nlibrary(kableExtra)\nlibrary(tictoc)\nsource(\"../functions.R\")\n```\n:::\n\n\n## Load data\n\nLoad the bundled data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- open_dataset(sources = data_dir(\"bundled_data/tdengue.parquet\")) %>%\n    select(mun, date, cases = cases_raw) %>%\n    collect()\n\ndim(dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 163326      3\n```\n:::\n:::\n\n\n### Prepare data\n\nThe chunk bellow executes various steps to prepare the data for clustering.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- dengue %>%\n  # Remove dates\n  filter(date >= as.Date(\"2011-01-01\") & date < as.Date(\"2020-01-01\")) %>%\n  # Create year variable\n  mutate(year = year(date)) %>%\n  # Create week number\n  mutate(week = epiweek(date)) %>%\n  # Summarise per year and isoweek\n  group_by(mun, year, week) %>%\n  summarise(cases = sum(cases, na.rm = TRUE)) %>%\n  ungroup() %>%\n  # Accumulate mun time series by year\n  group_by(mun, year) %>%\n  arrange(week) %>%\n  mutate(cases = cumsum(cases)) %>%\n  # Scale cases\n  mutate(cases = scale(cases)) %>%\n  ungroup() %>%\n  # Isolate municipality and year\n  mutate(mun = paste0(mun, \"_\", year)) %>%\n  select(-year, week) %>%\n  # Arrange data\n  arrange(mun, week) %>%\n  # Prepare time series of municipalities by year\n  mutate(mun = paste0(\"m_\", mun)) %>%\n  pivot_wider(names_from = mun, values_from = cases) %>%\n  select(-week) %>%\n  # Use zero value for years withot week 53\n  mutate(across(everything(), ~replace_na(.x, 0))) %>%\n  # Transpose as matrix\n  t() %>%\n  # Convert object\n  tslist()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'mun', 'year'. You can override using the\n`.groups` argument.\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(tdengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2934\n```\n:::\n:::\n\n\n## Clustering\n\nSequence of `k` groups to be used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk_seq <- 3:10\n```\n:::\n\n\n### Soft-DTW method\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nclust <- tsclust(\n  series = tdengue, \n  type = \"partitional\", \n  k = k_seq,\n  distance = \"sdtw\",\n  seed = 13\n)\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n43.611 sec elapsed\n```\n:::\n:::\n\n\n### Cluster Validity Indices (CVI)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(clust) <- paste0(\"k_\", k_seq)\nres_cvi <- sapply(clust, cvi, type = \"internal\") %>% \n  t() %>%\n  as_tibble(rownames = \"k\") %>%\n  arrange(-Sil)\n\nres_cvi %>%\n  kbl() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> k </th>\n   <th style=\"text-align:right;\"> Sil </th>\n   <th style=\"text-align:right;\"> SF </th>\n   <th style=\"text-align:right;\"> CH </th>\n   <th style=\"text-align:right;\"> DB </th>\n   <th style=\"text-align:right;\"> DBstar </th>\n   <th style=\"text-align:right;\"> D </th>\n   <th style=\"text-align:right;\"> COP </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> k_3 </td>\n   <td style=\"text-align:right;\"> 0.4918172 </td>\n   <td style=\"text-align:right;\"> 0.00e+00 </td>\n   <td style=\"text-align:right;\"> 468.5087 </td>\n   <td style=\"text-align:right;\"> 2.8884097 </td>\n   <td style=\"text-align:right;\"> 3.941104 </td>\n   <td style=\"text-align:right;\"> -0.0073765 </td>\n   <td style=\"text-align:right;\"> 0.0581442 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_7 </td>\n   <td style=\"text-align:right;\"> 0.4710792 </td>\n   <td style=\"text-align:right;\"> 6.80e-06 </td>\n   <td style=\"text-align:right;\"> 2187.5584 </td>\n   <td style=\"text-align:right;\"> 0.6958485 </td>\n   <td style=\"text-align:right;\"> 3.158036 </td>\n   <td style=\"text-align:right;\"> -0.0108925 </td>\n   <td style=\"text-align:right;\"> 0.0084996 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_10 </td>\n   <td style=\"text-align:right;\"> 0.4267091 </td>\n   <td style=\"text-align:right;\"> 7.00e-07 </td>\n   <td style=\"text-align:right;\"> 1720.2776 </td>\n   <td style=\"text-align:right;\"> 1.0498095 </td>\n   <td style=\"text-align:right;\"> 4.765099 </td>\n   <td style=\"text-align:right;\"> -0.0073776 </td>\n   <td style=\"text-align:right;\"> 0.0073875 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_9 </td>\n   <td style=\"text-align:right;\"> 0.3520963 </td>\n   <td style=\"text-align:right;\"> 1.37e-05 </td>\n   <td style=\"text-align:right;\"> 1692.5261 </td>\n   <td style=\"text-align:right;\"> 0.8059828 </td>\n   <td style=\"text-align:right;\"> -2.900259 </td>\n   <td style=\"text-align:right;\"> -0.0069788 </td>\n   <td style=\"text-align:right;\"> 0.0087052 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_6 </td>\n   <td style=\"text-align:right;\"> 0.3443733 </td>\n   <td style=\"text-align:right;\"> 3.14e-05 </td>\n   <td style=\"text-align:right;\"> 1361.1531 </td>\n   <td style=\"text-align:right;\"> 1.7157053 </td>\n   <td style=\"text-align:right;\"> 2.952545 </td>\n   <td style=\"text-align:right;\"> -0.0069719 </td>\n   <td style=\"text-align:right;\"> 0.0146054 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_5 </td>\n   <td style=\"text-align:right;\"> 0.3040909 </td>\n   <td style=\"text-align:right;\"> 0.00e+00 </td>\n   <td style=\"text-align:right;\"> 305.6034 </td>\n   <td style=\"text-align:right;\"> 3.8076163 </td>\n   <td style=\"text-align:right;\"> 7.811949 </td>\n   <td style=\"text-align:right;\"> -0.0069365 </td>\n   <td style=\"text-align:right;\"> 0.0514501 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_8 </td>\n   <td style=\"text-align:right;\"> 0.2912433 </td>\n   <td style=\"text-align:right;\"> 1.00e-07 </td>\n   <td style=\"text-align:right;\"> 1175.7666 </td>\n   <td style=\"text-align:right;\"> 3.4190993 </td>\n   <td style=\"text-align:right;\"> 28.269857 </td>\n   <td style=\"text-align:right;\"> -0.0069788 </td>\n   <td style=\"text-align:right;\"> 0.0125719 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_4 </td>\n   <td style=\"text-align:right;\"> 0.1189646 </td>\n   <td style=\"text-align:right;\"> 1.00e-06 </td>\n   <td style=\"text-align:right;\"> 218.1386 </td>\n   <td style=\"text-align:right;\"> 6.6201272 </td>\n   <td style=\"text-align:right;\"> 8.634171 </td>\n   <td style=\"text-align:right;\"> -0.0064559 </td>\n   <td style=\"text-align:right;\"> 0.0582817 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Cluster with higher Silhouette statistic\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_clust <- clust[[res_cvi[[1,1]]]]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust)\n```\n\n::: {.cell-output-display}\n![](cluster_mun_year_cumulative_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(filename = \"cluster_mun_year_cum.pdf\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSaving 7 x 5 in image\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust, type = \"centroids\", lty = 1)\n```\n\n::: {.cell-output-display}\n![](cluster_mun_year_cumulative_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(filename = \"cluster_mun_year_cum_centr.pdf\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSaving 7 x 5 in image\n```\n:::\n:::\n\n\n### Cluster sizes\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(sel_clust@cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n   1    2    3 \n2078  364  492 \n```\n:::\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0\nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nRandom number generation:\n RNG:     L'Ecuyer-CMRG \n Normal:  Inversion \n Sample:  Rejection \n \nlocale:\n [1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] tictoc_1.2       kableExtra_1.3.4 dtwclust_5.5.12  dtw_1.23-1      \n [5] proxy_0.4-27     timetk_2.8.3     arrow_12.0.1.1   lubridate_1.9.2 \n [9] forcats_1.0.0    stringr_1.5.0    dplyr_1.1.2      purrr_1.0.2     \n[13] readr_2.1.4      tidyr_1.3.0      tibble_3.2.1     ggplot2_3.4.3   \n[17] tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n  [1] colorspace_2.1-0    ellipsis_0.3.2      class_7.3-20       \n  [4] modeltools_0.2-23   clue_0.3-64         rstudioapi_0.15.0  \n  [7] farver_2.1.1        listenv_0.9.0       furrr_0.3.1        \n [10] dials_1.2.0         ggrepel_0.9.3       bit64_4.0.5        \n [13] RSpectra_0.16-1     prodlim_2023.03.31  fansi_1.0.4        \n [16] xml2_1.3.5          codetools_0.2-18    splines_4.1.2      \n [19] knitr_1.43          jsonlite_1.8.7      workflows_1.1.3    \n [22] cluster_2.1.2       yardstick_1.2.0     shiny_1.7.5        \n [25] tune_1.1.2          httr_1.4.7          compiler_4.1.2     \n [28] assertthat_0.2.1    Matrix_1.6-1        fastmap_1.1.1      \n [31] cli_3.6.1           later_1.3.1         htmltools_0.5.6    \n [34] tools_4.1.2         gtable_0.3.4        glue_1.6.2         \n [37] reshape2_1.4.4      Rcpp_1.0.11         DiceDesign_1.9     \n [40] vctrs_0.6.3         svglite_2.1.1       iterators_1.0.14   \n [43] parsnip_1.1.1       timeDate_4022.108   gower_1.0.1        \n [46] xfun_0.40           globals_0.16.2      rvest_1.0.3        \n [49] timechange_0.2.0    mime_0.12           lifecycle_1.0.3    \n [52] future_1.33.0       MASS_7.3-55         zoo_1.8-12         \n [55] scales_1.2.1        ipred_0.9-14        ragg_1.2.5         \n [58] hms_1.1.3           promises_1.2.1      parallel_4.1.2     \n [61] yaml_2.3.7          rpart_4.1.16        stringi_1.7.12     \n [64] highr_0.10          foreach_1.5.2       lhs_1.1.6          \n [67] hardhat_1.3.0       lava_1.7.2.1        systemfonts_1.0.4  \n [70] rlang_1.1.1         pkgconfig_2.0.3     rsample_1.2.0      \n [73] evaluate_0.21       lattice_0.20-45     labeling_0.4.2     \n [76] recipes_1.0.7       htmlwidgets_1.6.2   bit_4.0.5          \n [79] tidyselect_1.2.0    parallelly_1.36.0   plyr_1.8.8         \n [82] magrittr_2.0.3      R6_2.5.1            generics_0.1.3     \n [85] pillar_1.9.0        withr_2.5.0         xts_0.13.1         \n [88] survival_3.2-13     nnet_7.3-17         future.apply_1.11.0\n [91] utf8_1.2.3          tzdb_0.4.0          rmarkdown_2.24     \n [94] grid_4.1.2          flexclust_1.4-1     data.table_1.14.8  \n [97] webshot_0.5.5       digest_0.6.33       xtable_1.8-4       \n[100] httpuv_1.6.11       textshaping_0.3.6   RcppParallel_5.1.7 \n[103] stats4_4.1.2        GPfit_1.0-8         munsell_0.5.0      \n[106] viridisLite_0.4.2   shinyjs_2.1.0      \n```\n:::\n:::\n",
    "supporting": [
      "cluster_mun_year_cumulative_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}