{
  "hash": "96ed4117c3ae74fc9e95baeb085154d6",
  "result": {
    "markdown": "---\ntitle: \"Mun/epi year time series\"\nauthor: Raphael Saldanha\ndate: now\n---\n\n\nThis notebook aims to cluster the Brazilian municipalities cumulative dengue cases time-series yearly (starting on September) by its similarities.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)\nlibrary(arrow)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'arrow'\n\nThe following object is masked from 'package:lubridate':\n\n    duration\n\nThe following object is masked from 'package:utils':\n\n    timestamp\n```\n:::\n\n```{.r .cell-code}\nlibrary(timetk)\nlibrary(dtwclust)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: proxy\n\nAttaching package: 'proxy'\n\nThe following objects are masked from 'package:stats':\n\n    as.dist, dist\n\nThe following object is masked from 'package:base':\n\n    as.matrix\n\nLoading required package: dtw\nLoaded dtw v1.23-1. See ?dtw for help, citation(\"dtw\") for use in publication.\n\ndtwclust:\nSetting random number generator to L'Ecuyer-CMRG (see RNGkind()).\nTo read the included vignettes type: browseVignettes(\"dtwclust\").\nSee news(package = \"dtwclust\") after package updates.\n```\n:::\n\n```{.r .cell-code}\nlibrary(kableExtra)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'kableExtra'\n\nThe following object is masked from 'package:dplyr':\n\n    group_rows\n```\n:::\n\n```{.r .cell-code}\nlibrary(tictoc)\n```\n:::\n\n\n## Load data\n\nLoad the aggregated data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_parquet(\"../dengue-data/parquet_aggregated/dengue_md.parquet\")\n\ndim(dengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 16772737        3\n```\n:::\n:::\n\n\n### Prepare data\n\nThe chunk bellow executes various steps to prepare the data for clustering.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- dengue %>%\n  # Filter out dates after 2020-01-01, as this year is not complete\n  filter(date < as.Date(\"2020-01-01\")) %>%\n  # Pad days with zero cases\n  group_by(mun) %>%\n  pad_by_time(date, .by = \"day\", .pad_value = 0, .start_date = min(dengue$date), .end_date = max(dengue$date)) %>%\n  ungroup() %>%\n  # Aggregate by week\n  mutate(\n    week = str_pad(isoweek(date), pad = 0, width = 2),\n    year = year(date)\n  ) %>%\n  group_by(mun, year, week) %>%\n  summarise(freq = sum(freq, na.rm = TRUE)) %>%\n  ungroup() %>%\n  # Center year on September\n  group_by(mun) %>%\n  mutate(year = case_when(\n    week < 40 ~ year -1,\n    .default = year\n  )) %>%\n  ungroup() %>% \n  # Keep only municipalities/year series with more than 100 cases total\n  group_by(mun, year) %>%\n  mutate(total = sum(freq, na.rm = TRUE)) %>%\n  ungroup() %>%\n  filter(total >= 100) %>%\n  select(-total) %>%\n  # Scale cases by mun and year\n  group_by(mun, year) %>%\n  arrange(week) %>%\n  mutate(freq = scale(freq)) %>%\n  ungroup() %>%\n  arrange(mun, year, week) %>%\n  # Isolate municipality and year\n  mutate(mun = paste0(mun, \"_\", year)) %>%\n  select(-year, week) %>%\n  # Prepare time series of municipalities by year\n  mutate(mun = paste0(\"m_\", mun)) %>%\n  arrange(mun) %>%\n  pivot_wider(names_from = mun, values_from = freq) %>%\n  select(-week) %>%\n  t() %>%\n  # Convert object\n  tslist()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'mun', 'year'. You can override using the\n`.groups` argument.\n```\n:::\n\n```{.r .cell-code}\n# Remove missing values created by leap years (week 53)\ntdengue <- lapply(tdengue, na.omit)\n```\n:::\n\n\n## Clustering\n\nSequence of `k` groups to be used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk_seq <- 3:10\n```\n:::\n\n\n### SBD method\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nclust <- tsclust(\n  series = tdengue, \n  type = \"partitional\", \n  k = k_seq,\n  distance = \"sbd\",\n  seed = 13\n)\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n10.08 sec elapsed\n```\n:::\n:::\n\n\n### Cluster Validity Indices (CVI)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(clust) <- paste0(\"k_\", k_seq)\nres_cvi <- sapply(clust, cvi, type = \"internal\") %>% \n  t() %>%\n  as_tibble(rownames = \"k\") %>%\n  arrange(-Sil)\n\nres_cvi %>%\n  kbl() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> k </th>\n   <th style=\"text-align:right;\"> Sil </th>\n   <th style=\"text-align:right;\"> SF </th>\n   <th style=\"text-align:right;\"> CH </th>\n   <th style=\"text-align:right;\"> DB </th>\n   <th style=\"text-align:right;\"> DBstar </th>\n   <th style=\"text-align:right;\"> D </th>\n   <th style=\"text-align:right;\"> COP </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> k_4 </td>\n   <td style=\"text-align:right;\"> 0.1460031 </td>\n   <td style=\"text-align:right;\"> 0.3901889 </td>\n   <td style=\"text-align:right;\"> 1221.4732 </td>\n   <td style=\"text-align:right;\"> 1.729571 </td>\n   <td style=\"text-align:right;\"> 2.355575 </td>\n   <td style=\"text-align:right;\"> 0.0144472 </td>\n   <td style=\"text-align:right;\"> 0.2148113 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_3 </td>\n   <td style=\"text-align:right;\"> 0.1073370 </td>\n   <td style=\"text-align:right;\"> 0.4371917 </td>\n   <td style=\"text-align:right;\"> 1617.9353 </td>\n   <td style=\"text-align:right;\"> 2.098333 </td>\n   <td style=\"text-align:right;\"> 2.810307 </td>\n   <td style=\"text-align:right;\"> 0.0057479 </td>\n   <td style=\"text-align:right;\"> 0.2360803 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_5 </td>\n   <td style=\"text-align:right;\"> 0.0829643 </td>\n   <td style=\"text-align:right;\"> 0.3474048 </td>\n   <td style=\"text-align:right;\"> 777.9166 </td>\n   <td style=\"text-align:right;\"> 4.742646 </td>\n   <td style=\"text-align:right;\"> 6.109333 </td>\n   <td style=\"text-align:right;\"> 0.0060501 </td>\n   <td style=\"text-align:right;\"> 0.2178480 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_7 </td>\n   <td style=\"text-align:right;\"> 0.0447668 </td>\n   <td style=\"text-align:right;\"> 0.2792414 </td>\n   <td style=\"text-align:right;\"> 620.1160 </td>\n   <td style=\"text-align:right;\"> 3.894731 </td>\n   <td style=\"text-align:right;\"> 6.159100 </td>\n   <td style=\"text-align:right;\"> 0.0059028 </td>\n   <td style=\"text-align:right;\"> 0.2063219 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_9 </td>\n   <td style=\"text-align:right;\"> 0.0408667 </td>\n   <td style=\"text-align:right;\"> 0.1378384 </td>\n   <td style=\"text-align:right;\"> 520.9820 </td>\n   <td style=\"text-align:right;\"> 4.006004 </td>\n   <td style=\"text-align:right;\"> 7.405060 </td>\n   <td style=\"text-align:right;\"> 0.0069375 </td>\n   <td style=\"text-align:right;\"> 0.2034521 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_6 </td>\n   <td style=\"text-align:right;\"> 0.0306821 </td>\n   <td style=\"text-align:right;\"> 0.2620188 </td>\n   <td style=\"text-align:right;\"> 642.5254 </td>\n   <td style=\"text-align:right;\"> 3.478077 </td>\n   <td style=\"text-align:right;\"> 6.350471 </td>\n   <td style=\"text-align:right;\"> 0.0077663 </td>\n   <td style=\"text-align:right;\"> 0.2178271 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_10 </td>\n   <td style=\"text-align:right;\"> 0.0300852 </td>\n   <td style=\"text-align:right;\"> 0.1493126 </td>\n   <td style=\"text-align:right;\"> 471.9434 </td>\n   <td style=\"text-align:right;\"> 3.197318 </td>\n   <td style=\"text-align:right;\"> 5.172398 </td>\n   <td style=\"text-align:right;\"> 0.0106935 </td>\n   <td style=\"text-align:right;\"> 0.2003746 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_8 </td>\n   <td style=\"text-align:right;\"> 0.0298938 </td>\n   <td style=\"text-align:right;\"> 0.1695255 </td>\n   <td style=\"text-align:right;\"> 510.7171 </td>\n   <td style=\"text-align:right;\"> 3.721259 </td>\n   <td style=\"text-align:right;\"> 7.713016 </td>\n   <td style=\"text-align:right;\"> 0.0097268 </td>\n   <td style=\"text-align:right;\"> 0.2056778 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Cluster with higher Silhouette statistic\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_clust <- clust[[res_cvi[[1,1]]]]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust)\n```\n\n::: {.cell-output-display}\n![](cluster_mun_year_epi_year_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust, type = \"centroids\", lty = 1)\n```\n\n::: {.cell-output-display}\n![](cluster_mun_year_epi_year_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### Cluster sizes\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(sel_clust@cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n   1    2    3    4 \n1439  176 1361 3288 \n```\n:::\n:::\n",
    "supporting": [
      "cluster_mun_year_epi_year_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}