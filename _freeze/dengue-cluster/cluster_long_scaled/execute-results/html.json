{
  "hash": "98cb195359cb7fcf6f9baa479df38fd5",
  "result": {
    "markdown": "---\ntitle: \"Scaled cases\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\nThis notebook aims to cluster the Brazilian municipalities considering scaled (standardized) dengue cases time-series similarities.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(arrow)\nlibrary(timetk)\nlibrary(dtwclust)\nlibrary(kableExtra)\nlibrary(tictoc)\nsource(\"../functions.R\")\n```\n:::\n\n\n## Load data\n\nLoad the aggregated data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- open_dataset(sources = data_dir(\"bundled_data/tdengue.parquet\")) %>%\n    select(mun, date, cases) %>%\n    collect()\n\ndim(tdengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1529052       3\n```\n:::\n:::\n\n\n### Prepare data\n\nThe chunk bellow executes various steps to prepare the data for clustering.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- tdengue %>%\n  # Prepare time series\n  mutate(mun = paste0(\"m_\", mun)) %>%\n  arrange(mun, date) %>%\n  pivot_wider(names_from = mun, values_from = cases) %>%\n  select(-date) %>%\n  t() %>%\n  tslist()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(tdengue)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 3052\n```\n:::\n:::\n\n\n## Clustering\n\nSequence of `k` groups to be used.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk_seq <- 2:10\n```\n:::\n\n\n### GAK method\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nclust <- tsclust(\n  series = tdengue, \n  type = \"partitional\", \n  k = k_seq,\n  distance = \"gak\",\n  seed = 13\n)\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n5614.562 sec elapsed\n```\n:::\n:::\n\n\n### Cluster Validity Indices (CVI)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(clust) <- paste0(\"k_\", k_seq)\nres_cvi <- sapply(clust, cvi, type = \"internal\") %>% \n  t() %>%\n  as_tibble(rownames = \"k\") %>%\n  arrange(-Sil)\n\nres_cvi %>%\n  kbl() %>%\n  kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> k </th>\n   <th style=\"text-align:right;\"> Sil </th>\n   <th style=\"text-align:right;\"> SF </th>\n   <th style=\"text-align:right;\"> CH </th>\n   <th style=\"text-align:right;\"> DB </th>\n   <th style=\"text-align:right;\"> DBstar </th>\n   <th style=\"text-align:right;\"> D </th>\n   <th style=\"text-align:right;\"> COP </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> k_10 </td>\n   <td style=\"text-align:right;\"> 0.2824873 </td>\n   <td style=\"text-align:right;\"> 0.6298713 </td>\n   <td style=\"text-align:right;\"> 384.8193 </td>\n   <td style=\"text-align:right;\"> 1.740696 </td>\n   <td style=\"text-align:right;\"> 2.270314 </td>\n   <td style=\"text-align:right;\"> 0.0001173 </td>\n   <td style=\"text-align:right;\"> 0.1787297 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_9 </td>\n   <td style=\"text-align:right;\"> 0.2748321 </td>\n   <td style=\"text-align:right;\"> 0.6300657 </td>\n   <td style=\"text-align:right;\"> 375.3955 </td>\n   <td style=\"text-align:right;\"> 2.035515 </td>\n   <td style=\"text-align:right;\"> 2.509911 </td>\n   <td style=\"text-align:right;\"> 0.0001028 </td>\n   <td style=\"text-align:right;\"> 0.1883231 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_3 </td>\n   <td style=\"text-align:right;\"> 0.2648654 </td>\n   <td style=\"text-align:right;\"> 0.6311576 </td>\n   <td style=\"text-align:right;\"> 648.3349 </td>\n   <td style=\"text-align:right;\"> 1.927945 </td>\n   <td style=\"text-align:right;\"> 1.981710 </td>\n   <td style=\"text-align:right;\"> 0.0014661 </td>\n   <td style=\"text-align:right;\"> 0.2869358 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_7 </td>\n   <td style=\"text-align:right;\"> 0.2578026 </td>\n   <td style=\"text-align:right;\"> 0.6305156 </td>\n   <td style=\"text-align:right;\"> 474.7204 </td>\n   <td style=\"text-align:right;\"> 1.854999 </td>\n   <td style=\"text-align:right;\"> 2.397161 </td>\n   <td style=\"text-align:right;\"> 0.0015885 </td>\n   <td style=\"text-align:right;\"> 0.2004958 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_8 </td>\n   <td style=\"text-align:right;\"> 0.2404214 </td>\n   <td style=\"text-align:right;\"> 0.6302122 </td>\n   <td style=\"text-align:right;\"> 412.4559 </td>\n   <td style=\"text-align:right;\"> 2.750497 </td>\n   <td style=\"text-align:right;\"> 3.507225 </td>\n   <td style=\"text-align:right;\"> 0.0015934 </td>\n   <td style=\"text-align:right;\"> 0.1987060 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_5 </td>\n   <td style=\"text-align:right;\"> 0.1912735 </td>\n   <td style=\"text-align:right;\"> 0.6307432 </td>\n   <td style=\"text-align:right;\"> 379.9311 </td>\n   <td style=\"text-align:right;\"> 2.182433 </td>\n   <td style=\"text-align:right;\"> 2.249445 </td>\n   <td style=\"text-align:right;\"> 0.0014729 </td>\n   <td style=\"text-align:right;\"> 0.2776851 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_4 </td>\n   <td style=\"text-align:right;\"> 0.1817940 </td>\n   <td style=\"text-align:right;\"> 0.6309380 </td>\n   <td style=\"text-align:right;\"> 431.4281 </td>\n   <td style=\"text-align:right;\"> 3.118583 </td>\n   <td style=\"text-align:right;\"> 3.369465 </td>\n   <td style=\"text-align:right;\"> 0.0002715 </td>\n   <td style=\"text-align:right;\"> 0.2707786 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_6 </td>\n   <td style=\"text-align:right;\"> 0.1423482 </td>\n   <td style=\"text-align:right;\"> 0.6305953 </td>\n   <td style=\"text-align:right;\"> 339.5569 </td>\n   <td style=\"text-align:right;\"> 3.050722 </td>\n   <td style=\"text-align:right;\"> 3.536752 </td>\n   <td style=\"text-align:right;\"> 0.0014970 </td>\n   <td style=\"text-align:right;\"> 0.2548731 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> k_2 </td>\n   <td style=\"text-align:right;\"> 0.1415486 </td>\n   <td style=\"text-align:right;\"> 0.6313977 </td>\n   <td style=\"text-align:right;\"> 448.4857 </td>\n   <td style=\"text-align:right;\"> 10.060427 </td>\n   <td style=\"text-align:right;\"> 10.060427 </td>\n   <td style=\"text-align:right;\"> 0.0008962 </td>\n   <td style=\"text-align:right;\"> 0.3683506 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n### Cluster with higher Silhouette statistic\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_clust <- clust[[res_cvi[[1,1]]]]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust)\n```\n\n::: {.cell-output-display}\n![](cluster_long_scaled_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(filename = \"cluster_long_scaled.pdf\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSaving 7 x 5 in image\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sel_clust, type = \"centroids\", lty = 1)\n```\n\n::: {.cell-output-display}\n![](cluster_long_scaled_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### Cluster sizes\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(sel_clust@cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  1   2   3   4   5   6   7   8   9  10 \n530 506 227 268 338 101 340 346 278 118 \n```\n:::\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.1 (2023-06-16)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.3 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nRandom number generation:\n RNG:     L'Ecuyer-CMRG \n Normal:  Inversion \n Sample:  Rejection \n \nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] tictoc_1.2       kableExtra_1.3.4 dtwclust_5.5.12  dtw_1.23-1      \n [5] proxy_0.4-27     timetk_2.8.3     arrow_13.0.0     lubridate_1.9.2 \n [9] forcats_1.0.0    stringr_1.5.0    dplyr_1.1.3      purrr_1.0.2     \n[13] readr_2.1.4      tidyr_1.3.0      tibble_3.2.1     ggplot2_3.4.3   \n[17] tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n  [1] rlang_1.1.1         magrittr_2.0.3      clue_0.3-64        \n  [4] furrr_0.3.1         flexclust_1.4-1     compiler_4.3.1     \n  [7] systemfonts_1.0.4   vctrs_0.6.3         reshape2_1.4.4     \n [10] rvest_1.0.3         lhs_1.1.6           tune_1.1.2         \n [13] pkgconfig_2.0.3     fastmap_1.1.1       ellipsis_0.3.2     \n [16] labeling_0.4.3      utf8_1.2.3          promises_1.2.1     \n [19] rmarkdown_2.24      prodlim_2023.08.28  tzdb_0.4.0         \n [22] ragg_1.2.5          bit_4.0.5           xfun_0.40          \n [25] modeltools_0.2-23   jsonlite_1.8.7      recipes_1.0.8      \n [28] highr_0.10          later_1.3.1         parallel_4.3.1     \n [31] cluster_2.1.4       R6_2.5.1            stringi_1.7.12     \n [34] rsample_1.2.0       parallelly_1.36.0   rpart_4.1.19       \n [37] Rcpp_1.0.11         assertthat_0.2.1    dials_1.2.0        \n [40] iterators_1.0.14    knitr_1.43          future.apply_1.11.0\n [43] zoo_1.8-12          httpuv_1.6.11       Matrix_1.6-0       \n [46] splines_4.3.1       nnet_7.3-19         timechange_0.2.0   \n [49] tidyselect_1.2.0    rstudioapi_0.15.0   yaml_2.3.7         \n [52] timeDate_4022.108   codetools_0.2-19    listenv_0.9.0      \n [55] lattice_0.21-8      plyr_1.8.8          shiny_1.7.5        \n [58] withr_2.5.0         evaluate_0.21       future_1.33.0      \n [61] survival_3.5-5      RcppParallel_5.1.7  xml2_1.3.5         \n [64] xts_0.13.1          pillar_1.9.0        foreach_1.5.2      \n [67] stats4_4.3.1        shinyjs_2.1.0       generics_0.1.3     \n [70] hms_1.1.3           munsell_0.5.0       scales_1.2.1       \n [73] xtable_1.8-4        globals_0.16.2      class_7.3-22       \n [76] glue_1.6.2          tools_4.3.1         data.table_1.14.8  \n [79] RSpectra_0.16-1     webshot_0.5.5       gower_1.0.1        \n [82] grid_4.3.1          yardstick_1.2.0     ipred_0.9-14       \n [85] colorspace_2.1-0    cli_3.6.1           DiceDesign_1.9     \n [88] textshaping_0.3.6   workflows_1.1.3     parsnip_1.1.1      \n [91] fansi_1.0.4         viridisLite_0.4.2   svglite_2.1.1      \n [94] lava_1.7.2.1        gtable_0.3.4        GPfit_1.0-8        \n [97] digest_0.6.33       ggrepel_0.9.3       farver_2.1.1       \n[100] htmlwidgets_1.6.2   htmltools_0.5.6     lifecycle_1.0.3    \n[103] httr_1.4.7          hardhat_1.3.0       mime_0.12          \n[106] bit64_4.0.5         MASS_7.3-60        \n```\n:::\n:::\n",
    "supporting": [
      "cluster_long_scaled_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}