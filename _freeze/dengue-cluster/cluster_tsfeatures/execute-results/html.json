{
  "hash": "d863cb83b4d65d3e44c9c69aca94f44c",
  "result": {
    "markdown": "---\ntitle: \"Time series features\"\nsubtitle: \"with scaled cases\"\nauthor: \"Raphael Saldanha\"\ndate: last-modified\nbibliography: references.bib\n---\n\n\nThis notebook aims to explore time series features of dengue cases that may guide the clustering procedures. Time series features descriptions are quoted from @tsfeatures .\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\nlibrary(arrow)\nlibrary(tsfeatures)\n```\n:::\n\n\n## Load data\n\nLoad the bundled data (326 municipalities, pop $\\geq$ 100k inhab.) with standardized cases and keep only the municipality code, date and cases variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue <- read_parquet(\"../tdengue.parquet\") %>%\n  select(mun, date, cases)\n```\n:::\n\n\n## Prepare data\n\nConvert panel data to a list of `ts` objects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntdengue_df <- tdengue %>%\n  arrange(mun, date) %>%\n  select(-date) %>%\n  nest(data = cases, .by = mun)\n\ntdengue_list <- lapply(tdengue_df$data, ts)\n```\n:::\n\n\n## Time series features\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntsf <- tsfeatures(\n  tslist = tdengue_list, \n  features = c(\"entropy\", \"stability\", \"lumpiness\", \"flat_spots\", \"stl_features\", \"acf_features\")\n  )\ntsf$mun <- tdengue_df$mun\n```\n:::\n\n\n### Shannon entropy\n\n> Measures the \"forecastability\" of a time series, where low values indicate a high signal-to-noise ratio, and large values occur when a series is difficult to forecast.\n\n$$\n-\\int^\\pi_{-\\pi}\\hat{f}(\\lambda)\\log\\hat{f}(\\lambda) d\\lambda\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = entropy)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### Stability & lumpiness\n\n> Stability and lumpiness are two time series features based on tiled (non-overlapping) windows. Means or variances are produced for all tiled windows. Then stability is the variance of the means, while lumpiness is the variance of the variances.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = stability)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = lumpiness)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### Flat spots\n\n> Flat spots are computed by dividing the sample space of a time series into ten equal-sized intervals, and computing the maximum run length within any single interval.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = flat_spots)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n### STL features decomposition\n\n#### Trend\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = trend)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n#### Spike\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = spike)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n#### Linearity\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = linearity)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n#### Curvature\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = curvature)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n#### First autocorrelation coefficient\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = e_acf1)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n#### Sum of the first ten squared autocorrelation coefficients\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = e_acf10)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n### Autocorrelation function (ACF) features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = x_acf1)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = x_acf10)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = diff1_acf1)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = diff1_acf10)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = diff2_acf1)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf, aes(x = diff2_acf10)) +\n  geom_histogram(bins = 50, alpha = .7, fill = \"purple\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n## Clustering\n\nThis procedure goal is to cluster the municipalities considering time series features similarities.\n\n\n### K-means clustering\n\nCluster the municipalities based solely on the time series features.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npoints <- tsf %>%\n  select(-mun)\n```\n:::\n\n\nUses $k$ from 2 to 10 for clustering.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkclusts <- \n  tibble(k = 2:10) %>%\n  mutate(\n    kclust = map(k, ~kmeans(points, .x)),\n    tidied = map(kclust, tidy),\n    glanced = map(kclust, glance),\n    augmented = map(kclust, augment, points)\n  )\n```\n:::\n\n\nIsolate results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclusters <- \n  kclusts %>%\n  unnest(cols = c(tidied))\n\nassignments <- \n  kclusts %>% \n  unnest(cols = c(augmented))\n\nclusterings <- \n  kclusts %>%\n  unnest(cols = c(glanced))\n```\n:::\n\n\nThe total sum of squares is plotted. The \\$k=5\\$ seems to be a break point.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(clusterings, aes(k, tot.withinss)) +\n  geom_line() +\n  geom_point() +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n### Identify municipalities and cluster id\n\nFinally, the cluster partition ID is added to the main dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncluster_ids <- clusterings %>%\n  filter(k == 5) %>%\n  pull(augmented) %>%\n  pluck(1) %>%\n  select(group = .cluster) %>%\n  mutate(mun = tdengue_df$mun)\n```\n:::\n\n\n### Cluster sizes\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(cluster_ids$group)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  1   2   3   4   5 \n 12  66  43  90 115 \n```\n:::\n:::\n\n\n## Time series features per group\n\nAdd group Id to time series feautures.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntsf_group <- left_join(tsf, cluster_ids, by = \"mun\")\n```\n:::\n\n\n### Shannon entropy\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = entropy, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n### Stability & lumpiness\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = stability, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = lumpiness, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\n### Flat spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = flat_spots, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n\n### STL features decomposition\n\n#### Trend\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = trend, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\n#### Spike\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = spike, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n#### Linearity\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = linearity, , fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\n#### Curvature\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = curvature, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n\n#### First autocorrelation coefficient\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = e_acf1, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n\n#### Sum of the first ten squared autocorrelation coefficients\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = e_acf10, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n:::\n\n\n### Autocorrelation function (ACF) features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = x_acf1, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = x_acf10, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = diff1_acf1, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-40-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = diff1_acf10, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = diff2_acf1, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-42-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tsf_group, aes(x = diff2_acf10, fill = group)) +\n  geom_histogram(bins = 50, alpha = .7) +\n  facet_wrap(~ group) +\n  theme_bw() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](cluster_tsfeatures_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.2 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0\nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] tsfeatures_1.1     arrow_12.0.1       yardstick_1.2.0    workflowsets_1.0.1\n [5] workflows_1.1.3    tune_1.1.1         rsample_1.1.1      recipes_1.0.6     \n [9] parsnip_1.1.0      modeldata_1.1.0    infer_1.0.4        dials_1.2.0       \n[13] scales_1.2.1       broom_1.0.5        tidymodels_1.1.0   lubridate_1.9.2   \n[17] forcats_1.0.0      stringr_1.5.0      dplyr_1.1.2        purrr_1.0.1       \n[21] readr_2.1.4        tidyr_1.3.0        tibble_3.2.1       ggplot2_3.4.2     \n[25] tidyverse_2.0.0   \n\nloaded via a namespace (and not attached):\n [1] nlme_3.1-155        xts_0.13.1          bit64_4.0.5        \n [4] DiceDesign_1.9      tools_4.1.2         backports_1.4.1    \n [7] utf8_1.2.3          R6_2.5.1            rpart_4.1.16       \n[10] colorspace_2.1-0    nnet_7.3-17         withr_2.5.0        \n[13] tidyselect_1.2.0    curl_5.0.1          bit_4.0.5          \n[16] compiler_4.1.2      cli_3.6.1           labeling_0.4.2     \n[19] tseries_0.10-54     lmtest_0.9-40       fracdiff_1.5-2     \n[22] quadprog_1.5-8      digest_0.6.33       rmarkdown_2.23     \n[25] pkgconfig_2.0.3     htmltools_0.5.5     parallelly_1.36.0  \n[28] lhs_1.1.6           fastmap_1.1.1       TTR_0.24.3         \n[31] htmlwidgets_1.6.2   rlang_1.1.1         quantmod_0.4.24    \n[34] rstudioapi_0.15.0   farver_2.1.1        generics_0.1.3     \n[37] zoo_1.8-12          jsonlite_1.8.7      magrittr_2.0.3     \n[40] Matrix_1.6-0        Rcpp_1.0.11         munsell_0.5.0      \n[43] fansi_1.0.4         GPfit_1.0-8         lifecycle_1.0.3    \n[46] furrr_0.3.1         stringi_1.7.12      forecast_8.21      \n[49] yaml_2.3.7          MASS_7.3-55         grid_4.1.2         \n[52] parallel_4.1.2      listenv_0.9.0       lattice_0.20-45    \n[55] splines_4.1.2       hms_1.1.3           knitr_1.43         \n[58] pillar_1.9.0        future.apply_1.11.0 codetools_0.2-18   \n[61] urca_1.3-3          glue_1.6.2          evaluate_0.21      \n[64] data.table_1.14.8   vctrs_0.6.3         tzdb_0.4.0         \n[67] foreach_1.5.2       gtable_0.3.3        future_1.33.0      \n[70] assertthat_0.2.1    xfun_0.39           gower_1.0.1        \n[73] prodlim_2023.03.31  class_7.3-20        survival_3.2-13    \n[76] timeDate_4022.108   iterators_1.0.14    hardhat_1.3.0      \n[79] lava_1.7.2.1        timechange_0.2.0    globals_0.16.2     \n[82] ipred_0.9-14       \n```\n:::\n:::\n",
    "supporting": [
      "cluster_tsfeatures_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}