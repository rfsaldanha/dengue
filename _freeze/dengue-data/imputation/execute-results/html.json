{
  "hash": "f723418507f693b1c883cc43d2876222",
  "result": {
    "markdown": "---\ntitle: \"Imputation\"\nauthor: Raphael Saldanha\ndate: now\n---\n\n\n## Context\n\nThis notebook aims to imputate some missing data and enrich the dataset.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(arrow)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'arrow'\n\nThe following object is masked from 'package:lubridate':\n\n    duration\n\nThe following object is masked from 'package:utils':\n\n    timestamp\n```\n:::\n\n```{.r .cell-code}\nlibrary(knitr)\nlibrary(lubridate)\n```\n:::\n\n\n## Load data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimportant_vars <- c(\"ID_AGRAVO\", \"DT_NOTIFIC\", \"ID_UNIDADE\",\n                    \"DT_SIN_PRI\", \"CS_SEXO\", \"CS_GESTANT\",\n                    \"CS_RACA\", \"CS_ESCOL_N\", \"ID_MN_RESI\",\n                    \"COUFINF\", \"COMUNINF\", \"ID_OCUPA_N\",\n                    \"DT_SORO\", \"RESUL_SORO\", \"SOROTIPO\", \n                    \"CLASSI_FIN\", \"CRITERIO\", \"EVOLUCAO\",\n                    \"DT_OBITO\", \"HOSPITALIZ\", \"DT_INTERNA\")\n\ndengue <- open_dataset(sources = \"parquets/\") %>%\n  select(all_of(important_vars)) %>%\n  collect()\n```\n:::\n\n\n### Residence municipality: ID_MN_RESI\n\nTask: If ID_MN_RESI is invalid or missing, imputate with valid COMUNINF information.\n\n#### Imputation\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- dengue %>%\n  mutate(\n    ID_MN_RESI_check = if_else(nchar(ID_MN_RESI) == 6, \n                               false = FALSE,\n                               true = TRUE),\n    COMUNINF_check = if_else(nchar(COMUNINF) == 6, \n                               false = FALSE,\n                               true = TRUE)\n  ) %>%\n  mutate(ID_MN_RESI = case_when(\n    ID_MN_RESI_check == FALSE & COMUNINF_check == TRUE ~ COMUNINF,\n    is.na(ID_MN_RESI) ~ COMUNINF,\n    TRUE ~ ID_MN_RESI\n  )) %>%\n  select(-ID_MN_RESI_check, -COMUNINF_check)\n```\n:::\n\n\n#### Check improval\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue %>%\n  mutate(\n    ID_MN_RESI_check = if_else(nchar(ID_MN_RESI) == 6, \n                               false = FALSE,\n                               true = TRUE)\n  ) %>%\n  group_by(ID_MN_RESI_check) %>%\n  summarise(freq = n()) %>%\n  ungroup() %>%\n  kable(\n    format.args = list(big.mark = \".\", decimal.mark = \",\")\n  )\n```\n\n::: {.cell-output-display}\n|ID_MN_RESI_check |       freq|\n|:----------------|----------:|\n|FALSE            |          4|\n|TRUE             | 19.177.930|\n|NA               |      2.523|\n:::\n:::\n\n\nNo improvement for invalid municipalities, improvement of 96 records with missing data.\n\n### Date of the first symptoms onset: DT_SIN_PRI\n\nTask: If DT_SIN_PRI is invalid or missing, imputate with valid DT_NOTIFIC information.\n\n#### Imputation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalid_interval <- interval(ymd(\"2011-01-01\"), ymd(\"2021-12-31\"))\n\ndengue <- dengue %>%\n  mutate(\n    DT_SIN_PRI_check = ymd(DT_SIN_PRI) %within% valid_interval,\n    DT_NOTIFIC_check = ymd(DT_NOTIFIC) %within% valid_interval,\n  ) %>%\n  mutate(DT_SIN_PRI = case_when(\n    DT_SIN_PRI_check == FALSE & DT_NOTIFIC_check == TRUE ~ DT_NOTIFIC,\n    is.na(DT_SIN_PRI) ~ DT_NOTIFIC,\n    TRUE ~ DT_SIN_PRI\n  )) %>%\n  select(-DT_SIN_PRI_check, -DT_NOTIFIC_check)\n```\n:::\n\n\n#### Check improval\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalid_interval <- interval(ymd(\"2011-01-01\"), ymd(\"2021-12-31\"))\n\ndengue %>%\n  mutate(\n    DT_SIN_PRI_check = ymd(DT_SIN_PRI) %within% valid_interval\n  ) %>%\n  group_by(DT_SIN_PRI_check) %>%\n  summarise(freq = n()) %>%\n  ungroup() %>%\n  kable(\n    format.args = list(big.mark = \".\", decimal.mark = \",\")\n  )\n```\n\n::: {.cell-output-display}\n|DT_SIN_PRI_check |       freq|\n|:----------------|----------:|\n|FALSE            |  3.618.528|\n|TRUE             | 15.561.929|\n:::\n:::\n\n\nThere was a improvement on 25,823 records with invalid dates and all missing records were imputate.\n\n## Export improved database\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue %>%\n  write_parquet(sink = \"parquet_improved/dengue_improved.parquet\")\n```\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.1.2 (2021-11-01)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.2 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0\nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=pt_BR.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] knitr_1.43      arrow_12.0.0    lubridate_1.9.2 forcats_1.0.0  \n [5] stringr_1.5.0   dplyr_1.1.2     purrr_1.0.1     readr_2.1.4    \n [9] tidyr_1.3.0     tibble_3.2.1    ggplot2_3.4.2   tidyverse_2.0.0\n\nloaded via a namespace (and not attached):\n [1] compiler_4.1.2    pillar_1.9.0      tools_4.1.2       bit_4.0.5        \n [5] digest_0.6.31     timechange_0.2.0  jsonlite_1.8.5    evaluate_0.21    \n [9] lifecycle_1.0.3   gtable_0.3.3      pkgconfig_2.0.3   rlang_1.1.1      \n[13] cli_3.6.1         rstudioapi_0.14   yaml_2.3.7        xfun_0.39        \n[17] fastmap_1.1.1     withr_2.5.0       generics_0.1.3    vctrs_0.6.2      \n[21] htmlwidgets_1.6.2 hms_1.1.3         bit64_4.0.5       grid_4.1.2       \n[25] tidyselect_1.2.0  glue_1.6.2        R6_2.5.1          fansi_1.0.4      \n[29] rmarkdown_2.22    tzdb_0.4.0        magrittr_2.0.3    scales_1.2.1     \n[33] htmltools_0.5.5   assertthat_0.2.1  colorspace_2.1-0  utf8_1.2.3       \n[37] stringi_1.7.12    munsell_0.5.0    \n```\n:::\n:::\n",
    "supporting": [
      "imputation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}