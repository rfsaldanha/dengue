{
  "hash": "d0d4fb2a8807bfd80e7987e5fc3bd49c",
  "result": {
    "markdown": "---\ntitle: \"Imputation\"\nauthor: Raphael Saldanha\ndate: last-modified\n---\n\n\nThis notebook aims to impute some missing data and enrich the dataset.\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(arrow)\nlibrary(knitr)\nlibrary(lubridate)\nsource(\"../functions.R\")\n```\n:::\n\n\n### Execution node\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnode_name()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"rfsaldanha\"\n```\n:::\n:::\n\n\n## Load data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimportant_vars <- c(\"ID_AGRAVO\", \"DT_NOTIFIC\", \"ID_UNIDADE\",\n                    \"DT_SIN_PRI\", \"CS_SEXO\", \"CS_GESTANT\",\n                    \"CS_RACA\", \"CS_ESCOL_N\", \"ID_MN_RESI\",\n                    \"COUFINF\", \"COMUNINF\", \"ID_OCUPA_N\",\n                    \"DT_SORO\", \"RESUL_SORO\", \"SOROTIPO\", \n                    \"CLASSI_FIN\", \"CRITERIO\", \"EVOLUCAO\",\n                    \"DT_OBITO\", \"HOSPITALIZ\", \"DT_INTERNA\")\n\ndengue_files_list <- c(\n  data_dir(\"dengue_data/parquets/dengue_2011.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2012.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2013.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2014.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2015.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2016.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2017.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2018.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2019.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2020.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2021.parquet\"),\n  data_dir(\"dengue_data/parquets/dengue_2022.parquet\")\n)\n\ndengue <- open_dataset(sources = dengue_files_list) %>%\n  select(all_of(important_vars)) %>%\n  collect()\n```\n:::\n\n\n### Residence municipality: ID_MN_RESI\n\nTask: If ID_MN_RESI is invalid or missing, imputate with valid COMUNINF information.\n\n#### Imputation\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- dengue %>%\n  mutate(\n    ID_MN_RESI_check = if_else(nchar(ID_MN_RESI) == 6, \n                               false = FALSE,\n                               true = TRUE),\n    COMUNINF_check = if_else(nchar(COMUNINF) == 6, \n                               false = FALSE,\n                               true = TRUE)\n  ) %>%\n  mutate(ID_MN_RESI = case_when(\n    ID_MN_RESI_check == FALSE & COMUNINF_check == TRUE ~ COMUNINF,\n    is.na(ID_MN_RESI) ~ COMUNINF,\n    TRUE ~ ID_MN_RESI\n  )) %>%\n  select(-ID_MN_RESI_check, -COMUNINF_check)\n```\n:::\n\n\n#### Check improvement\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue %>%\n  mutate(\n    ID_MN_RESI_check = if_else(nchar(ID_MN_RESI) == 6, \n                               false = FALSE,\n                               true = TRUE)\n  ) %>%\n  group_by(ID_MN_RESI_check) %>%\n  summarise(freq = n()) %>%\n  ungroup() %>%\n  kable(\n    format.args = list(big.mark = \".\", decimal.mark = \",\")\n  )\n```\n\n::: {.cell-output-display}\n|ID_MN_RESI_check |       freq|\n|:----------------|----------:|\n|FALSE            |          4|\n|TRUE             | 16.953.774|\n|NA               |      2.223|\n:::\n:::\n\n\nNo improvement for invalid municipalities, improvement of 96 records with missing data.\n\n### Date of the first symptoms onset: DT_SIN_PRI\n\nTask: If DT_SIN_PRI is invalid or missing, imputate with valid DT_NOTIFIC information.\n\n#### Imputation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalid_interval <- interval(ymd(\"2011-01-01\"), ymd(\"2022-12-31\"))\n\ndengue <- dengue %>%\n  mutate(\n    DT_SIN_PRI_check = ymd(DT_SIN_PRI) %within% valid_interval,\n    DT_NOTIFIC_check = ymd(DT_NOTIFIC) %within% valid_interval,\n  ) %>%\n  mutate(DT_SIN_PRI = case_when(\n    DT_SIN_PRI_check == FALSE & DT_NOTIFIC_check == TRUE ~ DT_NOTIFIC,\n    is.na(DT_SIN_PRI) ~ DT_NOTIFIC,\n    TRUE ~ DT_SIN_PRI\n  )) %>%\n  select(-DT_SIN_PRI_check, -DT_NOTIFIC_check)\n```\n:::\n\n\n#### Check improvement\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvalid_interval <- interval(ymd(\"2011-01-01\"), ymd(\"2022-12-31\"))\n\ndengue %>%\n  mutate(\n    DT_SIN_PRI_check = ymd(DT_SIN_PRI) %within% valid_interval\n  ) %>%\n  group_by(DT_SIN_PRI_check) %>%\n  summarise(freq = n()) %>%\n  ungroup() %>%\n  kable(\n    format.args = list(big.mark = \".\", decimal.mark = \",\")\n  )\n```\n\n::: {.cell-output-display}\n|DT_SIN_PRI_check |       freq|\n|:----------------|----------:|\n|TRUE             | 16.956.001|\n:::\n:::\n\n\nThere was a improvement on 25,823 records with invalid dates and all missing records were imputate.\n\n## Export improved database\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue %>%\n  write_parquet(sink = data_dir(\"dengue_data/parquet_improved/dengue_improved.parquet\"))\n```\n:::\n\n\n## Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Ubuntu 22.04.4 LTS\n\nMatrix products: default\nBLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 \nLAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.10.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: Europe/Paris\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] knitr_1.45      arrow_14.0.0.2  lubridate_1.9.3 forcats_1.0.0  \n [5] stringr_1.5.1   dplyr_1.1.4     purrr_1.0.2     readr_2.1.5    \n [9] tidyr_1.3.1     tibble_3.2.1    ggplot2_3.4.4   tidyverse_2.0.0\n\nloaded via a namespace (and not attached):\n [1] bit_4.0.5         gtable_0.3.4      jsonlite_1.8.8    compiler_4.3.2   \n [5] tidyselect_1.2.0  assertthat_0.2.1  scales_1.3.0      yaml_2.3.8       \n [9] fastmap_1.1.1     R6_2.5.1          generics_0.1.3    htmlwidgets_1.6.4\n[13] munsell_0.5.0     pillar_1.9.0      tzdb_0.4.0        rlang_1.1.3      \n[17] utf8_1.2.4        stringi_1.8.3     xfun_0.42         bit64_4.0.5      \n[21] timechange_0.3.0  cli_3.6.2         withr_3.0.0       magrittr_2.0.3   \n[25] digest_0.6.34     grid_4.3.2        hms_1.1.3         lifecycle_1.0.4  \n[29] vctrs_0.6.5       evaluate_0.23     glue_1.7.0        fansi_1.0.6      \n[33] colorspace_2.1-0  rmarkdown_2.25    tools_4.3.2       pkgconfig_2.0.3  \n[37] htmltools_0.5.7  \n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}