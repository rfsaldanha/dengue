---
title: "Time series features"
subtitle: "with scaled cases"
author: "Raphael Saldanha"
date: last-modified
bibliography: references.bib
---

This notebook aims to explore time series features of dengue cases that may guide the clustering procedures. Time series features descriptions are quoted from @tsfeatures .

## Packages

```{r}
#| message: false
library(tidyverse)
library(tidymodels)
library(arrow)
library(tsfeatures)
```

## Load data

Load the bundled data (326 municipalities, pop $\geq$ 100k inhab.) with standardized cases and keep only the municipality code, date and cases variables.

```{r}
tdengue <- read_parquet("../tdengue.parquet") %>%
  select(mun, date, cases)
```

## Prepare data

Convert panel data to a list of `ts` objects.

```{r}
tdengue_df <- tdengue %>%
  arrange(mun, date) %>%
  select(-date) %>%
  nest(data = cases, .by = mun)

tdengue_list <- lapply(tdengue_df$data, ts)
```

## Time series features

```{r}
tsf <- tsfeatures(
  tslist = tdengue_list, 
  features = c("entropy", "stability", "lumpiness", "flat_spots", "stl_features", "acf_features")
  )
tsf$mun <- tdengue_df$mun
```

### Shannon entropy

> Measures the "forecastability" of a time series, where low values indicate a high signal-to-noise ratio, and large values occur when a series is difficult to forecast.

$$
-\int^\pi_{-\pi}\hat{f}(\lambda)\log\hat{f}(\lambda) d\lambda
$$

```{r}
ggplot(tsf, aes(x = entropy)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

### Stability & lumpiness

> Stability and lumpiness are two time series features based on tiled (non-overlapping) windows. Means or variances are produced for all tiled windows. Then stability is the variance of the means, while lumpiness is the variance of the variances.

```{r}
ggplot(tsf, aes(x = stability)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = lumpiness)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

### Flat spots

> Flat spots are computed by dividing the sample space of a time series into ten equal-sized intervals, and computing the maximum run length within any single interval.

```{r}
ggplot(tsf, aes(x = flat_spots)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

### STL features decomposition

#### Trend

```{r}
ggplot(tsf, aes(x = trend)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

#### Spike

```{r}
ggplot(tsf, aes(x = spike)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

#### Linearity

```{r}
ggplot(tsf, aes(x = linearity)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

#### Curvature

```{r}
ggplot(tsf, aes(x = curvature)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

#### First autocorrelation coefficient

```{r}
ggplot(tsf, aes(x = e_acf1)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

#### Sum of the first ten squared autocorrelation coefficients

```{r}
ggplot(tsf, aes(x = e_acf10)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

### Autocorrelation function (ACF) features

```{r}
ggplot(tsf, aes(x = x_acf1)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = x_acf10)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = diff1_acf1)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = diff1_acf10)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = diff2_acf1)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

```{r}
ggplot(tsf, aes(x = diff2_acf10)) +
  geom_histogram(bins = 50, alpha = .7, fill = "purple") +
  theme_bw()
```

## Clustering

This procedure goal is to cluster the municipalities considering time series features similarities.

### K-means clustering

Cluster the municipalities based solely on the time series features.

```{r}
points <- tsf %>%
  select(-mun)
```

Uses $k$ from 2 to 10 for clustering.

```{r}
kclusts <- 
  tibble(k = 2:10) %>%
  mutate(
    kclust = map(k, ~kmeans(points, .x)),
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, points)
  )
```

Isolate results.

```{r}
clusters <- 
  kclusts %>%
  unnest(cols = c(tidied))

assignments <- 
  kclusts %>% 
  unnest(cols = c(augmented))

clusterings <- 
  kclusts %>%
  unnest(cols = c(glanced))
```

The total sum of squares is plotted. The \$k=5\$ seems to be a break point.

```{r}
ggplot(clusterings, aes(k, tot.withinss)) +
  geom_line() +
  geom_point() +
  theme_bw()
```

### Identify municipalities and cluster id

Finally, the cluster partition ID is added to the main dataset.

```{r}
cluster_ids <- clusterings %>%
  filter(k == 5) %>%
  pull(augmented) %>%
  pluck(1) %>%
  select(group = .cluster) %>%
  mutate(mun = tdengue_df$mun)
```

### Cluster sizes

```{r}
table(cluster_ids$group)
```

## Time series features per group

Add group Id to time series feautures.

```{r}
tsf_group <- left_join(tsf, cluster_ids, by = "mun")
```

### Shannon entropy

```{r}
ggplot(tsf_group, aes(x = entropy, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

### Stability & lumpiness

```{r}
ggplot(tsf_group, aes(x = stability, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = lumpiness, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

### Flat spots

```{r}
ggplot(tsf_group, aes(x = flat_spots, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

### STL features decomposition

#### Trend

```{r}
ggplot(tsf_group, aes(x = trend, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

#### Spike

```{r}
ggplot(tsf_group, aes(x = spike, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

#### Linearity

```{r}
ggplot(tsf_group, aes(x = linearity, , fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

#### Curvature

```{r}
ggplot(tsf_group, aes(x = curvature, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

#### First autocorrelation coefficient

```{r}
ggplot(tsf_group, aes(x = e_acf1, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

#### Sum of the first ten squared autocorrelation coefficients

```{r}
ggplot(tsf_group, aes(x = e_acf10, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

### Autocorrelation function (ACF) features

```{r}
ggplot(tsf_group, aes(x = x_acf1, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = x_acf10, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = diff1_acf1, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = diff1_acf10, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = diff2_acf1, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
ggplot(tsf_group, aes(x = diff2_acf10, fill = group)) +
  geom_histogram(bins = 50, alpha = .7) +
  facet_wrap(~ group) +
  theme_bw() +
  theme(legend.position = "none")
```

## Session info

```{r}
sessionInfo()
```
